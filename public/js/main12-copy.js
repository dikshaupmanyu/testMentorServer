var config = {
    apiKey: "AIzaSyA0o46jRmw6OghL2fcpdIcNWDeG1EQ5upQ",
    authDomain: "tradetips-9baa3.firebaseapp.com",
    databaseURL: "https://tradetips-9baa3.firebaseio.com",
    projectId: "tradetips-9baa3",
    type: "service_account",
    project_id: "tradetips-9baa3",
    storageBucket: "tradetips-9baa3.appspot.com",
    messagingSenderId: "592114858590",
    appId: "1:592114858590:web:2e2f77237953b570fb52cf",
    measurementId: "G-B3RPK4JXG3",
    private_key_id: "9efaa0e3e7bf1fac231c69b552514e210442b223",
    private_key: "-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDoxICupYmqJ8yY\nmWkKk8lWp3dKzdAfOkAuyb8yrD9WWYOSUsAMIBY+irMBy74uFeJry8hfHicsBWSW\nuzL04S2S6dlJfeuBFI7GmgNIUG3GDfBROKeUS/XUzY2qg0+dNvgYgFbzoBNc0sMH\nxf4Ezarp/3CDqroWQRD0hvn2zUjNOnWqMP4NcZZfhyNJJcrFyvEWcMs8gWR0r+fQ\nijbGVgqf1n9T+HpGBXkXi9X3tZHe3HW4P6n0gjLU1eU8kOr6V6LDDAngp6ESsuQJ\nAyN81Sz9Axi4hygyWl7Oq7zpitVQxjHwzdMuWMGb/GbnHsleJRYHErk85qaHAvp1\nuS416baJAgMBAAECggEACe+VZJ8ZVMOVJrBpvPNZBVNpsq49Y4/bfIPNHw8eNwPk\nK2NP4lSeTnYiNQHq8NGrVBmjSHgjiOwEArEj+DMCfIJx7YKsAlsLyyt412XjgbBH\noVfvQ1PIvxg1I2GujNHzXixgSc779Jrki1jmwnK7CHkIZv5rKhcF78IxOllB8cyn\nsDdEOkYPAvYeVpIG1j3JQD4Yeo5xyT/MEhzZKqvNeg+uKkDS9R3P5jz94gRTbAtv\n3sKuS6Hrx2tn+BmqhpG1YFlKGMeTpAN42Jf96HJZQQvzho1AmTJh1Ep3fCgMOYhW\n0IJa1JnfVlHlZrL2NmLJ7ac+7yCIBPCXGtkihaHmzwKBgQD4g3si7vB2PBFTXxX5\nTJ0LubY/zyMp0sja/Rp2JYVVHh2WNHa6/TKyxksCG2OlMHbHV99QTrBuIyVYPWbN\njGPeQQAwd+y31RhHyePG99gwxvY8rRSzrEoPev6/6LHM5MdPqNzyujY0w0kUp5UR\nUyANKnCVeOll4IEmApBNfT3UhwKBgQDvx5buPbqdGA4mPKmEq/TLUy4OXVCnd1e3\nOe95qQIcbChCCAkSVeJ3nSvE5d0eBGJNlhaWeTA3DP/963o4frkRmaQJK9BsXdnb\nVj5iG3QRRKCYpamH1kY1AHc/G7P7a4hBPJ+4yblpGBiC7EayG9uBhgDA2sdLOPWW\nF1pZ20TwbwKBgAjz66a5hu4rgdBIF6mQigPXH+qykqi6EERbY+2nsmL7n8M+hpx7\n7KymGiOsSu2zjkPmNYRWIWMGXx0LsT1sdliWbORSHbQNuD811b/gQ+iV8l8DOUCz\nz0M5gh31yxn/j/KducAA110VP/e/hc5G+VugEMhBv97MtLpi00IHZgfXAoGBAIBq\nmWfQwY/+4R0TYgp++aSnUMQ6r8ZwwRaNPbcfj9TfDBSJLyqVuqsrDtTt8qVv3aIF\n3uUJ1Iu3N6arJZL6M228pkCPKZnQDaxNnS133IqfAY+fMZNha8pZDIRM9vCRH7Eo\nobYau2UQlZgQqLAdAUt2FBM1WITt5YFT0nzLVTmbAoGBAO/p5zqkeQ3Yjt7qIs8g\nbQTByK/9TsDRdiK9RfsEKuq70BHLuyYoW6jt9yR4AlbQHEFjGek9mWw4k45aZB5P\n2vjISHPiQoAAGVE9eowmvcckYn+IFFkNIs9s3UBX1d2RBzOgy3XMYE897DWGmKc+\n7F3mTXJtUyyjUqERXKBTYxN0\n-----END PRIVATE KEY-----\n",
    client_email: "firebase-adminsdk-olv1b@tradetips-9baa3.iam.gserviceaccount.com",
    client_id: "112955508654296836542",
    auth_uri: "https://accounts.google.com/o/oauth2/auth",
    token_uri: "https://oauth2.googleapis.com/token",
    auth_provider_x509_cert_url: "https://www.googleapis.com/oauth2/v1/certs",
    client_x509_cert_url: "https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-zgd2j%40chatdemo-96e4f.iam.gserviceaccount.com",
    vapidKey: 'BN2e4vqb2-OY-QX6Z0531oQ1pSiiEUNQU2SEcSaEiMvJFcy8unSAW6gPrFJQeHz0VQyPu2JLqVuaFDnfeDmpy3o'
    // apiKey: "AIzaSyA89MvmT1QzbvnCGfZ8B7yaJRuE3DwaOPE",
    // authDomain: "chatdemo-96e4f.firebaseapp.com",
    // databaseURL: "https://chatdemo-96e4f.firebaseio.com",
    // projectId: "chatdemo-96e4f",
    // type: "service_account",
    // project_id: "chatdemo-96e4f",
    // storageBucket: "chatdemo-96e4f.appspot.com",
    // messagingSenderId: "993956240122",
    // appId: "1:993956240122:web:cb9941a3090a8d029cc743",
    // private_key_id: "9efaa0e3e7bf1fac231c69b552514e210442b223",
    // private_key: "-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDoxICupYmqJ8yY\nmWkKk8lWp3dKzdAfOkAuyb8yrD9WWYOSUsAMIBY+irMBy74uFeJry8hfHicsBWSW\nuzL04S2S6dlJfeuBFI7GmgNIUG3GDfBROKeUS/XUzY2qg0+dNvgYgFbzoBNc0sMH\nxf4Ezarp/3CDqroWQRD0hvn2zUjNOnWqMP4NcZZfhyNJJcrFyvEWcMs8gWR0r+fQ\nijbGVgqf1n9T+HpGBXkXi9X3tZHe3HW4P6n0gjLU1eU8kOr6V6LDDAngp6ESsuQJ\nAyN81Sz9Axi4hygyWl7Oq7zpitVQxjHwzdMuWMGb/GbnHsleJRYHErk85qaHAvp1\nuS416baJAgMBAAECggEACe+VZJ8ZVMOVJrBpvPNZBVNpsq49Y4/bfIPNHw8eNwPk\nK2NP4lSeTnYiNQHq8NGrVBmjSHgjiOwEArEj+DMCfIJx7YKsAlsLyyt412XjgbBH\noVfvQ1PIvxg1I2GujNHzXixgSc779Jrki1jmwnK7CHkIZv5rKhcF78IxOllB8cyn\nsDdEOkYPAvYeVpIG1j3JQD4Yeo5xyT/MEhzZKqvNeg+uKkDS9R3P5jz94gRTbAtv\n3sKuS6Hrx2tn+BmqhpG1YFlKGMeTpAN42Jf96HJZQQvzho1AmTJh1Ep3fCgMOYhW\n0IJa1JnfVlHlZrL2NmLJ7ac+7yCIBPCXGtkihaHmzwKBgQD4g3si7vB2PBFTXxX5\nTJ0LubY/zyMp0sja/Rp2JYVVHh2WNHa6/TKyxksCG2OlMHbHV99QTrBuIyVYPWbN\njGPeQQAwd+y31RhHyePG99gwxvY8rRSzrEoPev6/6LHM5MdPqNzyujY0w0kUp5UR\nUyANKnCVeOll4IEmApBNfT3UhwKBgQDvx5buPbqdGA4mPKmEq/TLUy4OXVCnd1e3\nOe95qQIcbChCCAkSVeJ3nSvE5d0eBGJNlhaWeTA3DP/963o4frkRmaQJK9BsXdnb\nVj5iG3QRRKCYpamH1kY1AHc/G7P7a4hBPJ+4yblpGBiC7EayG9uBhgDA2sdLOPWW\nF1pZ20TwbwKBgAjz66a5hu4rgdBIF6mQigPXH+qykqi6EERbY+2nsmL7n8M+hpx7\n7KymGiOsSu2zjkPmNYRWIWMGXx0LsT1sdliWbORSHbQNuD811b/gQ+iV8l8DOUCz\nz0M5gh31yxn/j/KducAA110VP/e/hc5G+VugEMhBv97MtLpi00IHZgfXAoGBAIBq\nmWfQwY/+4R0TYgp++aSnUMQ6r8ZwwRaNPbcfj9TfDBSJLyqVuqsrDtTt8qVv3aIF\n3uUJ1Iu3N6arJZL6M228pkCPKZnQDaxNnS133IqfAY+fMZNha8pZDIRM9vCRH7Eo\nobYau2UQlZgQqLAdAUt2FBM1WITt5YFT0nzLVTmbAoGBAO/p5zqkeQ3Yjt7qIs8g\nbQTByK/9TsDRdiK9RfsEKuq70BHLuyYoW6jt9yR4AlbQHEFjGek9mWw4k45aZB5P\n2vjISHPiQoAAGVE9eowmvcckYn+IFFkNIs9s3UBX1d2RBzOgy3XMYE897DWGmKc+\n7F3mTXJtUyyjUqERXKBTYxN0\n-----END PRIVATE KEY-----\n",
    // client_email: "firebase-adminsdk-zgd2j@chatdemo-96e4f.iam.gserviceaccount.com",
    // client_id: "112955508654296836542",
    // auth_uri: "https://accounts.google.com/o/oauth2/auth",
    // token_uri: "https://oauth2.googleapis.com/token",
    // auth_provider_x509_cert_url: "https://www.googleapis.com/oauth2/v1/certs",
    // client_x509_cert_url: "https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-zgd2j%40chatdemo-96e4f.iam.gserviceaccount.com"

};

firebase.initializeApp(config);
 
var db = firebase.firestore();


const docRef = db.collection("/openGroups/demoOpenGroup1/messages/");
const tasksDOM = document.getElementById("tasks");

var fullName   = document.getElementById('user_nickname');
var message    = document.getElementById('btn-input');
var userId     = document.getElementById('user_id');
// alert(userId.value);

var hiddenId   = document.getElementById('hiddenId');


var date = document.getElementById('dateval');
// utility functions
function cleanData(snapshots) {
  let data = [];
  snapshots.forEach(function (doc) {
    data.push({ id: doc.id, ...doc.data() });
  });
  return data;
}

// form functions
function handleCreate(event) {

   event.preventDefault();
   var loggedInVal = document.getElementById('user_id').value;
   var loggedInName = document.getElementById('user_nickname').value;
  // var today = Date.now();
   //var str = today.toDateString().split(' ').slice(1).join(' ') + " at " + today.toLocaleTimeString() + " GMT+5:30";
       
  if(message.value != ""){

    let task = {
    userName: loggedInName,
    userId : loggedInVal,
    message: message.value,
    messageId : loggedInVal + "_"+  Date.now(),
    messageType : "text",
    createdDate :  Date.now(),
    profileImageUrl : "https://apistest.tradetipsapp.com/api/appUser/getImageByAppUserId?appUserId="+loggedInVal,
    messageSource : "Web"
    // status: "incomplete"
    };

    return docRef
      .add(task)
      .then((ref) => {
        console.log(ref.id);
        task.id = ref.id;
        // fullName.value = '';
        message.value  = '';
        // date.value = '';
        // return createTask(task);
      });

   } else {
    $(".successmsg").html('<span>Message not empty.</span>');
    setTimeout(function(){$(".successmsg").empty()}, 5000);
   }    
 
}



function getoutput(event,id) {

  if (!event || !event.target || !event.target.files || event.target.files.length === 0) {
    return;
  }

  const name = event.target.files[0].name;
  const lastDot = name.lastIndexOf('.');
  const fileName = name.substring(0, lastDot);
  const ext = name.substring(lastDot + 1);
  const type = event.target.files[0].type;
  var loggedInVal = user_id.value;
   var loggedInName = user_nickname.value;

  const file = event.target.files[0];

  const docRefreply = db.collection("/openGroups/demoOpenGroup1/messages/"+id+"/replies/");



 
  // if(file.type == "video/mp4" || "video/mov" || "video/wmv" || "video/avi" || "video/avchd" || "video/webm" || "video/mkv"){
   
   if(type == "video/mp4" || type == "video/webm" || type == "video/mov" || type == "video/wmv"|| type == "video/mkv"){

    firebase.storage().ref('message_storage_test_env/').child("photo_message_"+loggedInVal+"_"+"_"+Date.now()).put(file).then(function(snapshot) {
      return snapshot.ref.getDownloadURL()
   }).then(url => {
     console.log("Firebase storage image uploaded : ", url);
       
       
  let taskreplys = {
    userName: loggedInName,
    userId : loggedInVal,
    message: url,
    messageId : loggedInVal + "_"+ Date.now(),
    messageType : "video",
    createdDate : Date.now(),
    profileImageUrl : "https://apistest.tradetipsapp.com/api/appUser/getImageByAppUserId?appUserId="+loggedInVal,
    // status: "incomplete"
    messageSource : "Web"
  };
  return docRefreply
    .add(taskreplys)
    .then((ref) => {
      console.log(ref.id);

      // $("div#exampleModalCenter"+id).css("display", "none");

      taskreplys.id = ref.id;
      // fullName.value = '';
      message.value  = '';
      // date.value = '';
      // return createTask(task);
    });


    });

   }
  else if (type == "image/jpeg"|| type == "image/png" || type == "image/gif" || type == "image/jpg" || type == "image/webp") {


    firebase.storage().ref('message_storage_test_env/').child("photo_message_"+loggedInVal+"_"+"_"+Date.now()).put(file).then(function(snapshot) {
      return snapshot.ref.getDownloadURL()
   }).then(url => {
     console.log("Firebase storage image uploaded : ", url);
       
   
  let taskreplys  = {
    userName: loggedInName,
    userId : loggedInVal,
    message: url,
    messageId : loggedInVal + "_"+ Date.now(),
    messageType : "photo",
    createdDate : Date.now(),
    profileImageUrl : "https://apistest.tradetipsapp.com/api/appUser/getImageByAppUserId?appUserId="+loggedInVal,
    // status: "incomplete"
    messageSource : "Web"
  };
  return docRefreply
    .add(taskreplys)
    .then((ref) => {
      console.log(ref.id);
           // $("div#exampleModalCenter"+id).css("display", "none");

      taskreplys.id = ref.id;
      // fullName.value = '';
      message.value  = '';
      // date.value = '';
      // return createTask(task);
    });


    });
  }
else{


  firebase.storage().ref('message_storage_test_env/').child(file.name+"_"+Date.now()).put(file).then(function(snapshot) {
    return snapshot.ref.getDownloadURL()
 }).then(url => {
   console.log("Firebase storage image uploaded : ", url);
     
     
  let taskreplys  = {
    userName: loggedInName,
    userId : loggedInVal,
    message: url,
    messageId : loggedInVal + "_"+ Date.now(),
    messageType : "audio",
    createdDate : Date.now(),
    profileImageUrl : "https://apistest.tradetipsapp.com/api/appUser/getImageByAppUserId?appUserId="+loggedInVal,
    // status: "incomplete"
    messageSource : "Web"
  };
  return docRefreply
    .add(taskreplys)
    .then((ref) => {
      console.log(ref.id);

      // $("div#exampleModalCenter"+uniqueDocId).css("display", "none");

      taskreplys.id = ref.id;
      // fullName.value = '';
      message.value  = '';
      // date.value = '';
      // return createTask(task);
    });


  });

  
  }
  $(".successmsg").html('<span>Uploading File....</span>');
  setTimeout(function(){$(".successmsg").empty()}, 8000);
}


// popup functions
function popupCreate(event) {
   // alert("calling " + JSON.stringify(event));
     

   var docId     = document.getElementById('btn-input-replyId'+event).value;
   // alert(docId);
   // var ids = docId.value;
   // docRef.doc(ids).get().then(function(doc) {
  
   //     console.log(doc.id, " => ", doc.data());

   //      });
   var fullName   = document.getElementById('user_nickname');
  // alert(fullName.value);
   var message    = document.getElementById('btn-input-replymsg'+event);
   // alert(message.value);
   var userId     = document.getElementById('user_id');
   // alert(userId.value);
   
    
   var loggedInVal = userId.value;
   // alert(loggedInVal);
   var loggedInName = fullName.value;
   // alert(loggedInName);
   var uniqueDocId = docId;
   // alert(uniqueDocId);

   const docReply = db.collection("/openGroups/demoOpenGroup1/messages/"+uniqueDocId+"/replies/"); 
   // alert(docReply);
   
  if(message.value != ""){

    let taskR = {
    userName: loggedInName,
    userId : loggedInVal,
    message: message.value,
    messageId : loggedInVal + "_"+  Date.now(),
    messageType : "text",
    createdDate :  Date.now(),
    profileImageUrl : "https://apistest.tradetipsapp.com/api/appUser/getImageByAppUserId?appUserId="+loggedInVal,
    messageSource : "Web"
    // status: "incomplete"
    };

    return docReply
      .add(taskR)
      .then((ref) => {
        // console.log(ref);
     // console.log("div#exampleModalCenter"+uniqueDocId);

     // $("div#exampleModalCenter"+uniqueDocId).css("display", "none");

        taskR.id = ref.id;
        // fullName.value = '';
        message.value  = '';
        // console.log(message.value)
        // date.value = '';
        // return createTask(task);
      });

  
   } else {
    $(".successmsg").html('<span>Message not empty.</span>');
    setTimeout(function(){$(".successmsg").empty()}, 5000);
   }    

  

   event.preventDefault();
 
}



$('i.fa.fa-paperclip.attachment.btn.btn-primary').click(function () {
   // alert("calll");
  $("#imageUploaddata").trigger('click');
   // alert("data");
});

$("#imageUploaddata").on('change', function(e) {
  var val = $(this).val();
  // alert(val);
  // $(this).siblings('span').text(val);
  // $('#btn-input').text(val);

  $(this).siblings('input#btn-input').text(val);

   const file = e.target.files[0];
   console.log(file);
   console.log(file.name);
   console.log(file.type);

   var loggedInVal = user_id.value;
   var loggedInName = user_nickname.value;
  
  if(file.type == "video/mp4" || file.type == "video/webm" || file.type == "video/mov" || file.type == "video/wmv"|| file.type == "video/mkv"){

    firebase.storage().ref('message_storage_test_env/').child("photo_message_"+loggedInVal+"_"+"_"+Date.now()).put(file).then(function(snapshot) {
      return snapshot.ref.getDownloadURL()
      }).then(url => {
     console.log("Firebase storage image uploaded : ", url);
       
       
    let task = {
      userName: loggedInName,
      userId : loggedInVal,
      message: url,
      messageId : loggedInVal + "_"+ Date.now(),
      messageType : "video",
      createdDate : Date.now(),
      profileImageUrl : "https://apistest.tradetipsapp.com/api/appUser/getImageByAppUserId?appUserId="+loggedInVal,
      // status: "incomplete"
      messageSource : "Web"
    };
    return docRef
      .add(task)
      .then((ref) => {
        console.log(ref.id);
        task.id = ref.id;
        // fullName.value = '';
        message.value  = '';
        // date.value = '';
        // return createTask(task);
      });


      });

   } else if (file.type == "image/jpeg"|| file.type == "image/png" || file.type == "image/gif" || file.type == "image/jpg" || file.type == "image/webp") {


        firebase.storage().ref('message_storage_test_env/').child("photo_message_"+loggedInVal+"_"+"_"+Date.now()).put(file).then(function(snapshot) {
          return snapshot.ref.getDownloadURL()
       }).then(url => {
         console.log("Firebase storage image uploaded : ", url);
           
       
      let task = {
        userName: loggedInName,
        userId : loggedInVal,
        message: url,
        messageId : loggedInVal + "_"+ Date.now(),
        messageType : "photo",
        createdDate : Date.now(),
        profileImageUrl : "https://apistest.tradetipsapp.com/api/appUser/getImageByAppUserId?appUserId="+loggedInVal,
        // status: "incomplete"
        messageSource : "Web"
      };
      return docRef
        .add(task)
        .then((ref) => {
          console.log(ref.id);
          task.id = ref.id;
          // fullName.value = '';
          message.value  = '';
          // date.value = '';
          // return createTask(task);
        });


        });
  } else {


    firebase.storage().ref('message_storage_test_env/').child(file.name+"_"+Date.now()).put(file).then(function(snapshot) {
      return snapshot.ref.getDownloadURL()
   }).then(url => {
     console.log("Firebase storage image uploaded : ", url);
       
       
    let task = {
      userName: loggedInName,
      userId : loggedInVal,
      message: url,
      messageId : loggedInVal + "_"+ Date.now(),
      messageType : "audio",
      createdDate : Date.now(),
      profileImageUrl : "https://apistest.tradetipsapp.com/api/appUser/getImageByAppUserId?appUserId="+loggedInVal,
      // status: "incomplete"
      messageSource : "Web"
    };
    return docRef
      .add(task)
      .then((ref) => {
        console.log(ref.id);
        task.id = ref.id;
        // fullName.value = '';
        message.value  = '';
        // date.value = '';
        // return createTask(task);
      });


    });

  }

  $(".successmsg").html('<span style="left:-999em">Uploading File....</span>');
  setTimeout(function(){$(".successmsg").empty()}, 5000);
  // }else if(file.type == "audio/mpeg" || "audio/mp3" || "audio/wav" || "audio/wma" || "audio/aac" || "audio/m4a" || "audio/flac"){
 
  // }else if(file.type == "document/doc" || "document/docx" || "document/html" || "document/odt" || "document/pdf" || "document/ppt" || "document/txt"){

    // (file.type == "application/vnd.openxmlformats-officedocument.wordprocessingml.document" || file.type == "application/doc" || file.type == "application/docx" || file.type == "application/html" || file.type == "application/odt" || file.type == "application/pdf" || file.type == "application/ppt" || file.type == "application/txt" || file.type == "application/ms-doc" || file.type == "application/msword" || file.type == "application/ms-powerpoint" || file.type == "application/plain" || file.type == "audio/mpeg" || file.type == "audio/mp3" || file.type == "audio/wav" || file.type == "audio/aac" || file.type == "audio/m4a" || file.type == "audio/flac")

});


function handleDelete(id) {
    var txt;
          if (confirm("Are you sure you want to delete this chat ?")) {
             return docRef
            .doc(id)
            .delete()
            .then(() => document.getElementById(id).remove());
          } else {
            txt = "You pressed Cancel!";
          }
 
}

function handleDeleteReply(obj1,obj2) {

    const docRefreply = db.collection("/openGroups/demoOpenGroup1/messages/"+obj2+"/replies/");
    var txt;
          if (confirm("Are you sure you want to delete this chat ?")) {
             return docRefreply
            .doc(obj1)
            .delete()
            .then(() => document.getElementById(obj1).remove());
          } else {
            txt = "You pressed Cancel!";
          }
 
}

function replypopup(id) {
   fetchTasksReply(id);
   

}


// dom functions
function createTask(task) {
  // alert(task);
  // var sData = localStorage.getItem('allTokenData');
  // var storageData= JSON.parse(sData);
  var loggedInVal = user_id.value;
   var loggedInName = "<%= userName %>";

   messaging.onMessage((payload) => {
  alert('Message received. ', payload);
  // ...
});

}


// function totalreplycount(id ,res){

  // const docRefreply = db.collection("/openGroups/demoOpenGroup1/messages/"+id+"/replies/");
  //  docRefreply.orderBy("createdDate", "asc").onSnapshot(function(snapshots) {       
  //     // console.log("size         "  +  snapshots.size);
  //     res.status(200).send({length: snapshots.size});
  //  });


// }

// Firebase functions



function fetchTasks() {
  
//   docRef.where("createdDate", "==", 1642517230000)
// .get()
// .then(function(querySnapshot) {
//     querySnapshot.docChanges().forEach(function(change) {
      // console.log(doc.id);
      // console.log(change.doc.data().flag);
     
   
     docRef.orderBy("createdDate", "desc").limit(100).onSnapshot(function(snapshot) {
        snapshot.docChanges().reverse().forEach(function(change) {

         const docRefreply = db.collection("/openGroups/demoOpenGroup1/messages/"+change.doc.id+"/replies/");
           docRefreply.orderBy("createdDate", "asc").onSnapshot(function(snapshots) {       
           

              $("#sizedata"+change.doc.id).html(snapshots.size);
              $("#sizedatan"+change.doc.id).html(snapshots.size);

              if(snapshots.size == 0){
                // $("#finalVal"+change.doc.id).css("display", "block");
                $("#finalValn"+change.doc.id).css("display", "none");
              }else{
                $("#finalValn"+change.doc.id).css("display", "block");
                // $("#finalVal"+change.doc.id).css("display", "none");
              }
              
           });
        
          // var taskIds = change.doc.id;
          //     $.ajax({

          //       type: 'GET',
          //       url: '/totalreplycount',
          //       data: {ids : taskIds},

          //     success: function(datas) {

          //       console.log("final data  "  + JSON.stringify(datas));

          //     }

          //   });


         // var countReplyss;

       

            if (change.type === "added") {
              
                var task = change.doc.data();

              

                  var userIdcs     = document.getElementById('user_id');
                    // console.log(userIdcs.value);
                    var userNamescs = document.getElementById("user_nickname");
                   // console.log(userNamecss.value);
                    var loggedInVal = userIdcs.value;
                    // console.log(loggedInVal);
                   var loggedInName = userNamescs.value;
                    // console.log(loggedInName);

                      var taskId = change.doc.id;
                      // console.log(taskId);

                    if(task.flag){
                       const result = task.flag.some(obj => obj.messageFlagedUserId === loggedInVal);
                        console.log("checking flag result  " + result);
                        if(result == true){
                          const elem = document.createElement("li");
                          elem.id = change.doc.id;
                          elem.innerHTML = "";
                          tasksDOM.append(elem);

                        }else{
                            // var countReply = countReplyss;
                            const elem = document.createElement("li");
                            elem.id = change.doc.id;
                            elem.innerHTML = reviewTemplate(task,loggedInVal,loggedInName,taskId);
                            tasksDOM.append(elem);
                        }
                      }else{
                            // var countReply = countReplyss;
                            const elem = document.createElement("li");
                            elem.id = change.doc.id;
                            elem.innerHTML = reviewTemplate(task,loggedInVal,loggedInName,taskId);
                            tasksDOM.append(elem);
                      }

              $('.card-body').scrollTop($('.card-body')[0].scrollHeight);


              // const deleteBtn = document.createElement("button");
              // deleteBtn.setAttribute("class", "btn btn-danger col-2 text-white");
              // deleteBtn.innerHTML =
              //   '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>';
              // deleteBtn.addEventListener("click", function () {
              //   return handleDelete(task.messageId);
              // });
              // elem.append(deleteBtn);

              // tasksDOM.append(elem);
            }
            if (change.type === "modified") {
                // console.log("Modified city: ", change.doc.data());
            }
            if (change.type === "removed") {
                // console.log("Removed city: ", change.doc.data());
            }


         });
      });

// });
}

 fetchTasks();


 function fetchTasksReply(id) {

    var docId     = id;
      const docRefreply = db.collection("/openGroups/demoOpenGroup1/messages/"+docId+"/replies/");
    
     docRefreply.orderBy("createdDate", "asc").onSnapshot(function(snapshots) {
      // alert(snapshots.size);
       if(snapshots.size == 0){
          const tasksDOMReply = document.getElementById("tasksreply"+docId);
          const elemreplys = document.createElement("li");
              console.log(elemreplys)
                elemreplys.innerHTML = "<img src='/images/noreply.png' style='display:block;margin:0 auto; overflow:auto; width:22.5%'><h3 class='text-center'><b>No Replies Yet</b></h3><br><p class='text-center'>Enter your messages here.</p>";
                // alert(elemreplys);
                tasksDOMReply.append(elemreplys);
                $('ul#tasksreply'+id).show()         
      }
      else{

        snapshots.docChanges().forEach(function(changes) {
            // alert(snapshots.size);
            if (changes.type === "added") {
                const tasksDOMReply = document.getElementById("tasksreply"+docId);
                var taskreply = changes.doc.data();
                var taskId = changes.doc.id;
                var userIdcs     = document.getElementById('user_id');
                    // console.log(userIdcs.value);
                    var userNamescs = document.getElementById("user_nickname");
                   // console.log(userNamecss.value);
                    var loggedInVal = userIdcs.value;
                    // console.log(loggedInVal);
                   var loggedInName = userNamescs.value;
                    // console.log(loggedInName);
                const elemreply = document.createElement("li");
                elemreply.id = changes.doc.id;
                elemreply.innerHTML = reviewTemplateReply(taskreply,loggedInVal,loggedInName,taskId,docId);
                tasksDOMReply.append(elemreply);
                // $('ul#tasksreply'+id).empty()
            }

        });

      }

    });




}




// var reviewForm = document.getElementById('reviewForm');
// // var fullName   = document.getElementById('user_nickname');
// // var message    = document.getElementById('message');
// // var userId     = document.getElementById('user_id');
// // var hiddenId   = document.getElementById('hiddenId');
// // var date = document.getElementById('dateval');

// // reviewForm.addEventListener('submit', (e) => {
// //   e.preventDefault();

// //   if (!fullName.value || !message.value || !date.value) return null

// //   var id = hiddenId.value || Date.now()

// //   db.collection('/openGroups/demoOpenGroup1/messages/').add({
// //     userName: fullName.value,
// //     userId : userId.value,
// //     message: message.value,
// //     createdDate : date.value
// //   }).then(function(doc) {
// //         // console.log(docRef);
// //         // console.log("Document written with ID: ", docRef.id);

// //   var li = document.createElement('li')
// //   li.id = doc.id;
// //   li.innerHTML = reviewTemplate('<li class="admin clearfix"><span class="chat-img right clearfix mx-2"><img src="https://apistest.tradetipsapp.com/api/appUser/getImageByAppUserId?appUserId=d9aced23-7b89-4abc-bd71-5523ab83a98a" alt="Admin" class="img-circle" style="width: 100%;"/></span><div class="chat-body clearfix"><div class="header clearfix"><small class="left text-muted"><span class="glyphicon glyphicon-time"></span>' + createdDate + '</small><strong class="right primary-font" class="fullName"> ' + userName + '</strong></div><p class="message"> ' + message + '</p></div></li>')
// //   reviews.appendChild(li);

// //     });

 

// //     fullName.value = '';
// //     message.value  = '';
// //     hiddenId.value = '';
// //     date.value = '';

// //   });

// // // READ REVEIWS



 

// // var reviews = document.getElementById('reviews');
// // var reviewsRef = db.ref("/reviews");
// // var reviewsRef = db.collection('openGroups').doc('demoOpenGroup1').collection('messages');
// // var reviewsRef = db.collection("/openGroups/demoOpenGroup1/messages").get().then((querySnapshot) => {
     
// //     // querySnapshot.forEach((doc) => {
// //         // alert(`${doc.id} => ${doc.data()}`);
// //          // sub_array.push(doc.data());

// //   // var li = document.createElement('li')
// //   // li.id = doc.id;
// //   // li.innerHTML = reviewTemplate(doc.data())
// //   // reviews.appendChild(li);
       
         
// //     // });

// //   });


// // var reviewsRef =

//  // db.collection("/openGroups/demoOpenGroup1/messages").get().then((querySnapshot) => {

//  //        var sub_array = [];
     
//  //    querySnapshot.forEach((doc) => {
//  //        // alert(`${doc.id} => ${doc.data()}`);
//  //         // sub_array.push(doc.data());
//  //    // alert(doc.id);
//  //  var li = document.createElement('li')
//  //  li.id = doc.id;
//  //  li.innerHTML = reviewTemplate(doc.data())
//  //  reviews.appendChild(li);
       
         
//  //    });

//  //  });

// // reviewsRef.on('child_added', (data) => {
// //   alert("add value" + data.val());
// //   var li = document.createElement('li')
// //   li.id = data.key;
// //   li.innerHTML = reviewTemplate(data.val())
// //   reviews.appendChild(li);
// // });


// // reviewsRef.on('child_changed', (data) => {
// //   alert("change" + data);
// //   var reviewNode = document.getElementById(data.key);
// //   reviewNode.innerHTML = reviewTemplate(data.val());
// // });

// // reviewsRef.on('child_removed', (data) => {
// //   alert("remove" + data);
// //   var reviewNode = document.getElementById(data.key);
// //   reviewNode.parentNode.removeChild(reviewNode);
// // });

// // reviews.addEventListener('click', (e) => {
// //   var reviewNode = e.target.parentNode

// //   // UPDATE REVEIW
// //   if (e.target.classList.contains('edit')) {
// //     fullName.value = reviewNode.querySelector('.fullName').innerText;
// //     message.value  = reviewNode.querySelector('.message').innerText;
// //     hiddenId.value = reviewNode.id;
// //   }

// //   // DELETE REVEIW
// //   if (e.target.classList.contains('delete')) {
// //     var id = reviewNode.id;
// //     db.ref('reviews/' + id).remove();
// //   }
// // });
function reviewTemplate({profileImageUrl,userName,userId, message,createdDate,messageType,messageId},loggedInName,loggedInVal,taskId) {

 // console.log("userid " + userId);
 // console.log("logged In " + loggedInName);

                const date = new Date(createdDate); //new Date(createdDate).toDateString();
                  //console.log(date);
                var options = {year: "numeric", month: "long", day: "numeric"};
                var newdate = date.toGMTString('en-US', options);  
                // console.log(newdate);
                // const stripped = newdate.replace(/GMT/g, 'EST');
                const stripped = newdate.replace(/GMT/g, '');
                // console.log(stripped);
                  // alert(date);
                var newdate1 = stripped.toString(stripped);  
                // console.log(newdate1);
                var newdate2 = newdate1.split(/(\s+)/);
                 newdate2.splice(11, 18);
                 newdate2.splice(0, 2);
                 newdate2.splice(3,3);
                // console.log(newdate2);
                 function moveArrayItemToNewIndex(arr, old_index, new_index) {
                 if (new_index >= arr.length) {
                      var k = new_index - arr.length + 1;
                      while (k--) {
                          arr.push(undefined);
                      }
                  }
                 arr.splice(new_index, 0, arr.splice(old_index, 1)[0]);
                 return arr;
                 };

                moveArrayItemToNewIndex(newdate2, 0, 2);
                var result1 = moveArrayItemToNewIndex(newdate2, 0, 2);
                //console.log(result1);
                result1.splice(1, 0, ' ');
                var newdate3 = result1.toString(result1);
                var result = newdate3.replace(/,/g, "");
                //console.log(result);
                x = result.substring(0, 6) + "," + result.substring(6, result.length);
                // console.log(x);
                function formatAMPM(date) {
                    var hours = date.getHours();
                    var minutes = date.getMinutes();
                    var ampm = hours >= 12 ? 'PM' : 'AM';
                    hours = hours % 12;
                    hours = hours ? hours : 12; // the hour '0' should be '12'
                    minutes = minutes < 10 ? '0'+minutes : minutes;
                    var strTime = hours + ':' + minutes + ' ' + ampm;
                    return strTime;
                  }

                  var date1 = formatAMPM(date);
                  //console.log(date1);
                  //console.log(newdate2);
                  const stripped1 = x.replace(newdate2[4], date1);
                  // console.log(stripped1);
                  
                  var fileName = message.substring(message.lastIndexOf('%') + 3);
                  // console.log(fileName)
     var fName = fileName.substring(0, fileName.indexOf("?"));
    //  console.log(fName+"this is fNAME")

   if(loggedInName == userId){

        if(messageType == "text"){

           return `

            <li class="admin clearfix">
           
              <span class="chat-img right clearfix mx-2">
                  <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
              </span>
              <div class="chat-body clearfix">
            <div class="Overlay">
                <div class="Overlay-1">
                  <div class="Content"  id='Popup${taskId}'>
                    <a role="button" data-toggle="modal" data-target="#myModal${taskId}""  > <div  class="Pop" onClick='replypopup(this.id)' id='${taskId}'>Reply</div></a>  
                    <a onClick='copyClipboard(this.id)' id='${taskId}'><div class="Pop">Copy</div></a>
                    <a onClick='handleDelete(this.id)' id='${taskId}' style="color:white;cursor:pointer;"><div class="Pop2">Delete</div></a>
                  </div>
                </div>
            </div>
                  <div class="header clearfix">
                      <small class="left text-muted" style = "display:inline-block;"><span class="glyphicon glyphicon-time"><div id="finalValn${taskId}"><a onClick='replypopup(this.id)' id='${taskId}' role="button" data-toggle="modal" data-target="#exampleModalCenter${taskId}">  Replies : <span id="sizedatan${taskId}"></span></a> </div></span>${stripped1}</small>
                    
                      <strong class="right primary-font" class='fullName'>${userName}</strong>
                  </div>
                  <p class='message' id="${taskId}">
                      <span id='textMessage${taskId}'>${message} <svg class="Chevron" onclick="TogglePopup(this.id)" id="${taskId}"  xmlns="http://www.w3.org/2000/svg" x="0px" y="0px"
                      width="24" height="24"
                      viewBox="0 0 172 172"
                      style=" fill:#000000;"><g fill="none" fill-rule="nonzero" stroke="none" stroke-width="1" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="10" stroke-dasharray="" stroke-dashoffset="0" font-family="none" font-weight="none" font-size="none" text-anchor="none" style="mix-blend-mode: normal"><path d="M0,172v-172h172v172z" fill="none"></path><g fill="#ffffff"><path d="M124.36689,70.61689l-35.83333,35.83333c-0.67183,0.67205 -1.58315,1.04963 -2.53342,1.04963c-0.95026,0 -1.86159,-0.37757 -2.53342,-1.04963l-35.83333,-35.83333c-1.35798,-1.40602 -1.33856,-3.64097 0.04365,-5.02318c1.38221,-1.38221 3.61716,-1.40163 5.02318,-0.04365l33.29977,33.29977l33.29977,-33.29985c1.40602,-1.35798 3.64097,-1.33856 5.02318,0.04365c1.38221,1.38221 1.40163,3.61716 0.04365,5.02318z"></path></g></g></svg><span>

                  </p>
                  
              </div>
             
          </li>

          <div class="container">
        
        
          <!-- The Modal -->
          <div class="modal" id="myModal${taskId}">
            <div class="modal-dialog">

            <form id="${taskId}">
              <div class="modal-content">
              
                <!-- Modal Header -->
                <div class="modal-header">
                  <h5 class="modal-title" id="myModal${taskId}">Reply</h5>
                  <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                
                <!-- Modal body -->
                <div class="msg-body">
                  <h5>${userName} : <label class="msg-detail"> ${message}</label></h5> 
                </div>

                <div class="modal-body">
                <ul class="chat" id="tasksreply${taskId}">
                </ul>
                </div>
                
                <!-- Modal footer -->
                <div class="modal-footer">

                    <input type="file" class="fa fa-paperclip attachment btn btn-primary_1" id='${taskId}' name='inputfile' onChange='getoutput(event,this.id)'/>
                    <input id="btn-input-replyId${taskId}" type="hidden" class="form-control input-lg" value="${taskId}" placeholder="Type your message here..." />
                    <input id="btn-input-replymsg${taskId}" type="text" class="form-control input-lg" value="" placeholder="Type your message here..."  autocomplete="off" />
                    <input type="button" id="emoji-buttons${taskId}" dataid="${taskId}" onclick="emojifunction(this.value)" value="${taskId}">
                  
                    <span class="input-group-btn">
                        <button class="btn btn-primary" type="button" onClick='popupCreate(this.id)' id="${taskId}">
                            <i class="fa fa-paper-plane" aria-hidden="true"></i>
                        </button>
                    </span>
                </div>
                
              </div>
            </div>
            </form>
          </div>
          
        </div>

        

          `
    

         }else if(messageType == "photo"){

           return `

            <li class="admin clearfix">
              <span class="chat-img right clearfix mx-2">
                  <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
              </span>
              <div class="chat-body clearfix">
              <div class="Overlay">
                  <div class="Overlay-1">
                    <div class="Content-2" id='Popup${taskId}'>
                      <div  class="Pop" onClick='replypopup(this.id)' id='${taskId}'><a  role="button" data-toggle="modal" data-target="#exampleModalCenter${taskId}">  Reply </a> </div> 
                      <a onClick='handleDelete(this.id)' id='${taskId}' style="color:white;cursor:pointer;"><div class="Pop2">Delete</div></a>
                    </div>
                  </div>
              </div>
                  <div class="header clearfix">
                      <small class="left text-muted"><span class="glyphicon glyphicon-time"><div id="finalValn${taskId}"><a onClick='replypopup(this.id)' id='${taskId}' role="button" data-toggle="modal" data-target="#exampleModalCenter${taskId}"> Replies : <span id="sizedatan${taskId}"></span></a> </div></span>${stripped1}</small>
                       
                      <strong class="right primary-font" class='fullName'>${userName}</strong>
                  </div>
                    <p class='message'><img src="${message}" class="img-responsive" style="width:200px;"/> <svg class="Chevron" onclick="TogglePopup(this.id)" id="${taskId}"  xmlns="http://www.w3.org/2000/svg" x="0px" y="0px"
                    width="24" height="24"
                    viewBox="0 0 172 172"
                    style=" fill:#000000;"><g fill="none" fill-rule="nonzero" stroke="none" stroke-width="1" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="10" stroke-dasharray="" stroke-dashoffset="0" font-family="none" font-weight="none" font-size="none" text-anchor="none" style="mix-blend-mode: normal"><path d="M0,172v-172h172v172z" fill="none"></path><g fill="#ffffff"><path d="M124.36689,70.61689l-35.83333,35.83333c-0.67183,0.67205 -1.58315,1.04963 -2.53342,1.04963c-0.95026,0 -1.86159,-0.37757 -2.53342,-1.04963l-35.83333,-35.83333c-1.35798,-1.40602 -1.33856,-3.64097 0.04365,-5.02318c1.38221,-1.38221 3.61716,-1.40163 5.02318,-0.04365l33.29977,33.29977l33.29977,-33.29985c1.40602,-1.35798 3.64097,-1.33856 5.02318,0.04365c1.38221,1.38221 1.40163,3.61716 0.04365,5.02318z"></path></g></g></svg>
                    </p>
              </div>
          </li>
         <div class="modal fade" id="exampleModalCenter${taskId}" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle${taskId}" aria-hidden="true" data-backdrop="static" data-keyboard="false">
                  <div class="modal-dialog modal-lg" role="document" style="top:40px;">
                  
                  <form id="${taskId}">
                  
                    <div class="modal-content"> 
                      <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLongTitle${taskId}">Reply</h5>
                        
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close" onClick='closepopup(this.id)' id='${taskId}' style="cursor:pointer">
                        &times
                        </button>
                      </div>
                      <div class="msg-body">
                        <h5>${userName} : <label class="msg-detail"> ${message}</label></h5> 
                      </div>
                       <div class="modal-body" style="height:250px;overflow-y:scroll;">
                         <ul class="chat" id="tasksreply${taskId}">
                         </ul>
                      </div>
                      <div class="modal-footer">
                      <input type="file" class="fa fa-paperclip attachment btn btn-primary_1" id='${taskId}' name='inputfile' onChange='getoutput(event,this.id)'/>
                        <input id="btn-input-replyId${taskId}" type="hidden" class="form-control input-lg" value="${taskId}" placeholder="Type your message here..." />
                        <input id="btn-input-replymsg${taskId}" type="text" class="form-control input-lg" value="" placeholder="Type your message here..."  autocomplete="off"/>
                         
                         
                        
                        <span class="input-group-btn">
                            <button class="btn btn-primary" type="button" onClick='popupCreate(this.id)' id="${taskId}">
                                <i class="fa fa-paper-plane" aria-hidden="true"></i>
                            </button>
                        </span>
                      </div>
                    </div>
                  </form>
                  </div>
                </div>
          `

        }else if(messageType == "video"){

          return `

            <li class="admin clearfix">
              <span class="chat-img right clearfix mx-2">
                  <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
              </span>
              <div class="chat-body clearfix">

              <div class="Overlay">
                  <div class="Overlay-1">
                    <div class="Content-2"  id='Popup${taskId}'>
                      <div  class="Pop" onClick='replypopup(this.id)' id='${taskId}'><a  role="button" data-toggle="modal" data-target="#exampleModalCenter${taskId}">Reply </a> </div> 
                      <a onClick='handleDelete(this.id)' id='${taskId}' style="color:white;cursor:pointer;"><div class="Pop2">Delete</div></a>
                    </div>
                  </div>
              </div>
                  <div class="header clearfix">
                      <small class="left text-muted"><span class="glyphicon glyphicon-time"><div id="finalValn${taskId}"><a onClick='replypopup(this.id)' id='${taskId}' role="button" data-toggle="modal" data-target="#exampleModalCenter${taskId}">  Replies : <span id="sizedatan${taskId}"></span> </a> </div></span>${stripped1}</small>
                     
                      <strong class="right primary-font" class='fullName'>${userName}</strong>
                  </div>
                 <p class='message'><video controls style="width:100%;"><source src="${message}" type="video/mp4"></video> <svg class="Chevron" onclick="TogglePopup(this.id)" id="${taskId}"  xmlns="http://www.w3.org/2000/svg" x="0px" y="0px"
                 width="24" height="24"
                 viewBox="0 0 172 172"
                 style=" fill:#000000;"><g fill="none" fill-rule="nonzero" stroke="none" stroke-width="1" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="10" stroke-dasharray="" stroke-dashoffset="0" font-family="none" font-weight="none" font-size="none" text-anchor="none" style="mix-blend-mode: normal"><path d="M0,172v-172h172v172z" fill="none"></path><g fill="#ffffff"><path d="M124.36689,70.61689l-35.83333,35.83333c-0.67183,0.67205 -1.58315,1.04963 -2.53342,1.04963c-0.95026,0 -1.86159,-0.37757 -2.53342,-1.04963l-35.83333,-35.83333c-1.35798,-1.40602 -1.33856,-3.64097 0.04365,-5.02318c1.38221,-1.38221 3.61716,-1.40163 5.02318,-0.04365l33.29977,33.29977l33.29977,-33.29985c1.40602,-1.35798 3.64097,-1.33856 5.02318,0.04365c1.38221,1.38221 1.40163,3.61716 0.04365,5.02318z"></path></g></g></svg>
                 </p>
              </div>
          </li>
          <div class="modal fade" id="exampleModalCenter${taskId}" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle${taskId}" aria-hidden="true" data-backdrop="static" data-keyboard="false">
                  <div class="modal-dialog modal-lg" role="document" style="top:40px;">
                  
                  <form id="${taskId}">
                  
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLongTitle${taskId}">Reply</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close" onClick='closepopup(this.id)' id='${taskId}' style="cursor:pointer">
                        &times
                        </button>
                      </div>
                      <div class="msg-body">
                        <h5>${userName} : <label class="msg-detail"> ${message}</label></h5> 
                      </div>
                       <div class="modal-body" style="height:250px;overflow-y:scroll;">
                         <ul class="chat" id="tasksreply${taskId}">
                         </ul>
                      </div>
                      <div class="modal-footer">
                      <input type="file" class="fa fa-paperclip attachment btn btn-primary_1" id='${taskId}' name='inputfile' onChange='getoutput(event,this.id)'/>
                        <input id="btn-input-replyId${taskId}" type="hidden" class="form-control input-lg" value="${taskId}" placeholder="Type your message here..." />
                        <input id="btn-input-replymsg${taskId}" type="text" class="form-control input-lg" value="" placeholder="Type your message here..."  autocomplete="off"/>

                        
                        <span class="input-group-btn">
                            <button class="btn btn-primary" type="button" onClick='popupCreate(this.id)' id="${taskId}">
                                <i class="fa fa-paper-plane" aria-hidden="true"></i>
                            </button>
                        </span>
                      </div>
                    </div>
                  </form>
                  </div>
                </div>
          `
        
        }else if(messageType == "document"){

          return `

            <li class="admin clearfix">
              <span class="chat-img right clearfix mx-2">
                  <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
              </span>
              <div class="chat-body clearfix">

              <div class="Overlay">
                  <div class="Overlay-1">
                    <div class="Content-2"  id='Popup${taskId}'>
                    <a role="button" data-toggle="modal" data-target="#exampleModalCenter${taskId}"> <div class="Pop" onClick='replypopup(this.id)' id='${taskId}'>Reply</div></a>  
                      <a onClick='handleDelete(this.id)' id='${taskId}' style="color:white;cursor:pointer;"><div class="Pop2">Delete</div></a>
                    </div>
                  </div>
              </div>
                  <div class="header clearfix">
                      <small class="left text-muted"><span class="glyphicon glyphicon-time"><div id="finalValn${taskId}"><a onClick='replypopup(this.id)' id='${taskId}' role="button" data-toggle="modal" data-target="#exampleModalCenter${taskId}"> Replies : <span id="sizedatan${taskId}"></span></a> </div></span>${stripped1}</small>
                     
                      <strong class="right primary-font" class='fullName'>${userName}</strong>
                  </div>
                  <p class='message'><a href="${message}" target="_blank">  <svg class="Chevron" onclick="TogglePopup(this.id)" id="${taskId}"  xmlns="http://www.w3.org/2000/svg" x="0px" y="0px"
                  width="24" height="24"
                  viewBox="0 0 172 172"
                  style=" fill:#000000;"><g fill="none" fill-rule="nonzero" stroke="none" stroke-width="1" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="10" stroke-dasharray="" stroke-dashoffset="0" font-family="none" font-weight="none" font-size="none" text-anchor="none" style="mix-blend-mode: normal"><path d="M0,172v-172h172v172z" fill="none"></path><g fill="#ffffff"><path d="M124.36689,70.61689l-35.83333,35.83333c-0.67183,0.67205 -1.58315,1.04963 -2.53342,1.04963c-0.95026,0 -1.86159,-0.37757 -2.53342,-1.04963l-35.83333,-35.83333c-1.35798,-1.40602 -1.33856,-3.64097 0.04365,-5.02318c1.38221,-1.38221 3.61716,-1.40163 5.02318,-0.04365l33.29977,33.29977l33.29977,-33.29985c1.40602,-1.35798 3.64097,-1.33856 5.02318,0.04365c1.38221,1.38221 1.40163,3.61716 0.04365,5.02318z"></path></g></g></svg>
                  <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px"
                  width="25" height="25"
                  viewBox="0 0 172 172"
                  style=" fill:#000000;"><g fill="none" fill-rule="nonzero" stroke="none" stroke-width="1" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="10" stroke-dasharray="" stroke-dashoffset="0" font-family="none" font-weight="none" font-size="none" text-anchor="none" style="mix-blend-mode: normal"><path d="M0,172v-172h172v172z" fill="none"></path><g fill="#ecf0f1"><path d="M44.79167,14.33333c-8.89025,0 -16.125,7.23475 -16.125,16.125v111.08333c0,8.89025 7.23475,16.125 16.125,16.125h82.41667c8.89025,0 16.125,-7.23475 16.125,-16.125v-69.875h-41.20833c-8.89025,0 -16.125,-7.23475 -16.125,-16.125v-41.20833zM96.75,17.48275v38.05892c0,2.96342 2.41158,5.375 5.375,5.375h38.05892z"></path></g></g></svg>
                   ${fName}</a></p>
              </div>
          </li>
          <div class="modal fade" id="exampleModalCenter${taskId}" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle${taskId}" aria-hidden="true" data-backdrop="static" data-keyboard="false">
                  <div class="modal-dialog modal-lg" role="document" style="top:40px;">
                  
                  <form id="${taskId}">
                  
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLongTitle${taskId}">Reply</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close" onClick='closepopup(this.id)' id='${taskId}' style="cursor:pointer">
                        &times
                        </button>
                      </div>
                      <div class="msg-body">
                        <h5>${userName} : <label class="msg-detail"> ${message}</label></h5> 
                      </div>
                       <div class="modal-body" style="height:250px;overflow-y:scroll;">
                         <ul class="chat" id="tasksreply${taskId}">
                         </ul>
                      </div>
                      <div class="modal-footer">
                      <input type="file" class="fa fa-paperclip attachment btn btn-primary_1" id='${taskId}' name='inputfile' onChange='getoutput(event,this.id)'/>
                        <input id="btn-input-replyId${taskId}" type="hidden" class="form-control input-lg" value="${taskId}" placeholder="Type your message here..." />
                        <input id="btn-input-replymsg${taskId}" type="text" class="form-control input-lg" value="" placeholder="Type your message here..."  autocomplete="off"/>


                        <span class="input-group-btn">
                            <button class="btn btn-primary" type="button" onClick='popupCreate(this.id)' id="${taskId}">
                                <i class="fa fa-paper-plane" aria-hidden="true"></i>
                            </button>
                        </span>
                      </div>
                    </div>
                  </form>
                  </div>
                </div>
          `
        } else {

          return `

            <li class="admin clearfix">
              <span class="chat-img right clearfix mx-2">
                  <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
              </span>
              <div class="chat-body clearfix">

                  <div class="Overlay">
                      <div class="Overlay-1">
                        <div class="Content-2"  id='Popup${taskId}'>
                          <a role="button" data-toggle="modal" data-target="#exampleModalCenter${taskId}"> <div class="Pop" onClick='replypopup(this.id)' id='${taskId}'>Reply</div></a>  
                          <a onClick='handleDelete(this.id)' id='${taskId}' style="color:white;cursor:pointer;"><div class="Pop2">Delete</div></a>
                        </div>
                      </div>
                  </div>
                  <div class="header clearfix">
                      <small class="left text-muted"><span class="glyphicon glyphicon-time"><div id="finalValn${taskId}"><a onClick='replypopup(this.id)' id='${taskId}' role="button" data-toggle="modal" data-target="#exampleModalCenter${taskId}"> Replies : <span id="sizedatan${taskId}"></span></a> </div></span>${stripped1}</small>
                     
                      <strong class="right primary-font" class='fullName'>${userName}</strong>
                  </div>
                  
                  <p class='message'><a href="${message}" target="_blank">  <svg class="Chevron" onclick="TogglePopup(this.id)" id="${taskId}"  xmlns="http://www.w3.org/2000/svg" x="0px" y="0px"
                  width="24" height="24"
                  viewBox="0 0 172 172"
                  style=" fill:#000000;"><g fill="none" fill-rule="nonzero" stroke="none" stroke-width="1" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="10" stroke-dasharray="" stroke-dashoffset="0" font-family="none" font-weight="none" font-size="none" text-anchor="none" style="mix-blend-mode: normal"><path d="M0,172v-172h172v172z" fill="none"></path><g fill="#ffffff"><path d="M124.36689,70.61689l-35.83333,35.83333c-0.67183,0.67205 -1.58315,1.04963 -2.53342,1.04963c-0.95026,0 -1.86159,-0.37757 -2.53342,-1.04963l-35.83333,-35.83333c-1.35798,-1.40602 -1.33856,-3.64097 0.04365,-5.02318c1.38221,-1.38221 3.61716,-1.40163 5.02318,-0.04365l33.29977,33.29977l33.29977,-33.29985c1.40602,-1.35798 3.64097,-1.33856 5.02318,0.04365c1.38221,1.38221 1.40163,3.61716 0.04365,5.02318z"></path></g></g></svg>
                  <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px"
                  width="25" height="25"
                  viewBox="0 0 172 172"
                  style=" fill:#000000;"><g fill="none" fill-rule="nonzero" stroke="none" stroke-width="1" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="10" stroke-dasharray="" stroke-dashoffset="0" font-family="none" font-weight="none" font-size="none" text-anchor="none" style="mix-blend-mode: normal"><path d="M0,172v-172h172v172z" fill="none"></path><g fill="#ecf0f1"><path d="M44.79167,14.33333c-8.89025,0 -16.125,7.23475 -16.125,16.125v111.08333c0,8.89025 7.23475,16.125 16.125,16.125h82.41667c8.89025,0 16.125,-7.23475 16.125,-16.125v-69.875h-41.20833c-8.89025,0 -16.125,-7.23475 -16.125,-16.125v-41.20833zM96.75,17.48275v38.05892c0,2.96342 2.41158,5.375 5.375,5.375h38.05892z"></path></g></g></svg>
                   ${fName}</a></p>
          </li>
          <div class="modal fade" id="exampleModalCenter${taskId}" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle${taskId}" aria-hidden="true" data-backdrop="static" data-keyboard="false">
                  <div class="modal-dialog modal-lg" role="document" style="top:40px;">
                  
                  <form id="${taskId}">
                  
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLongTitle${taskId}">Reply</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close" onClick='closepopup(this.id)' id='${taskId}' style="cursor:pointer">
                        &times
                        </button>
                      </div>
                      <div class="msg-body">
                        <h5>${userName} : <label class="msg-detail"> ${message}</label></h5> 
                      </div>
                       <div class="modal-body" style="height:250px;overflow-y:scroll;">
                         <ul class="chat" id="tasksreply${taskId}">
                         </ul>
                      </div>
                      <div class="modal-footer">
                      <input type="file" class="fa fa-paperclip attachment btn btn-primary_1" id='${taskId}' name='inputfile' onChange='getoutput(event,this.id)'/>
                        <input id="btn-input-replyId${taskId}" type="hidden" class="form-control input-lg" value="${taskId}" placeholder="Type your message here..." />
                        <input id="btn-input-replymsg${taskId}" type="text" class="form-control input-lg" value="" placeholder="Type your message here..."  autocomplete="off"/>


                        <span class="input-group-btn">
                            <button class="btn btn-primary" type="button" onClick='popupCreate(this.id)' id="${taskId}">
                                <i class="fa fa-paper-plane" aria-hidden="true"></i>
                            </button>
                        </span>
                      </div>
                    </div>
                  </form>
                  </div>
                </div>
          `

        }

   }else{




     if(messageType == "text"){


         return `

        <li class="agent clearfix">
          <span class="chat-img left clearfix mx-2">
              <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
          </span>
          
          <div class="chat-body clearfix agent" style="float:none;background:#77839647;color:#000;" >
          
          <div class="overlay">
              <div class="overlay-1">
              <div class="content"  id='popup${taskId}'>
              <a role="button" data-toggle="modal" data-target="#exampleModalCenter${taskId}"> <div class="Pop" onClick='replypopup(this.id)' id='${taskId}'>Reply</div></a>  
              <a onClick='copyClipboard(this.id)' id='${taskId}'><div class="pop" style="cursor:pointer;">Copy</div></a>
              <a data-toggle="modal" data-target="#exampleModalCenterFlag${taskId}"><div class="pop2">Flag</div></a>
              </div>
              </div>
          </div>
         
              <div class="header clearfix">
                  <small class="right text-muted" style="color: #000"><span class="glyphicon glyphicon-time"><div id="finalValn${taskId}"><a onClick='replypopup(this.id)' id='${taskId}' role="button" data-toggle="modal" data-target="#exampleModalCenter${taskId}"> Replies : <span id="sizedatan${taskId}"></span></a> </div></span>${stripped1} </small>
                  <strong class="primary-font" class='fullName' style="color: #000">${userName}</strong>
              </div>
              <p class='message' style="color: #000 !important" >

              <span id="textMessage${taskId}">
                        ${message} <img class="chevron" onclick="togglePopup(this.id)" id="${taskId}" src="https://img.icons8.com/external-royyan-wijaya-detailed-outline-royyan-wijaya/24/000000/external-chevron-arrow-line-royyan-wijaya-detailed-outline-royyan-wijaya.png"/>
              </span>
               
              </p>

              
          </div>
          
          
      </li>
              <div class="modal fade" id="exampleModalCenter${taskId}" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle${taskId}" aria-hidden="true" data-backdrop="static" data-keyboard="false">
                  <div class="modal-dialog modal-lg" role="document" style="top:40px;">
                  
                  <form id="${taskId}">
                  
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLongTitle${taskId}">Reply</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close" onClick='closepopup(this.id)' id='${taskId}' style="cursor:pointer">
                          &times
                        </button>
                      </div>
                      <div class="msg-body">
                        <h5>${userName} : <label class="msg-detail"> ${message}</label></h5> 
                      </div>
                      <div class="modal-body" style="height:250px;overflow-y:scroll;">
                         <ul class="chat" id="tasksreply${taskId}">
                         </ul>
                      </div>
                      <div class="modal-footer">
                      <input type="file" class="fa fa-paperclip attachment btn btn-primary_1" id='${taskId}' name='inputfile' onChange='getoutput(event,this.id)'/>
                        <input id="btn-input-replyId${taskId}" type="hidden" class="form-control input-lg" value="${taskId}" placeholder="Type your message here..." />
                        <input id="btn-input-replymsg${taskId}" type="text" class="form-control input-lg" value="" placeholder="Type your message here..."  autocomplete="off"/>


                        <span class="input-group-btn">
                            <button class="btn btn-primary" type="button" onClick='popupCreate(this.id)' id="${taskId}">
                                <i class="fa fa-paper-plane" aria-hidden="true"></i>
                            </button>
                        </span>
                      </div>
                    </div>
                  </form>
                  </div>
                </div>
                <div class="modal fade" id="exampleModalCenterFlag${taskId}" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                      <div>
                        <h5 class="header-flag" id="exampleModalLongTitle">Reason For Flag</h5>
                      </div>

                       <div class="Flag">
                          <div class="reasonFlag">
                          <a><div class="flag" onClick='flagData(this.id ,"Offensive")' id='${taskId}' value="Offensive">Offensive</div></a>
                          <a><div class="flag" onClick='flagData(this.id ,"Irrevalent")' id='${taskId}' value="Irrevalent">Irrelaavent</div></a>
                          <a><div class="flag" onClick='flagData(this.id ,"Other")' id='${taskId}' value="Other">Other</div></a>
                          <a><div class="flag1" type="button" data-dismiss="modal">Cancel</div></a>
                          </div>
                      </div>
                    
                    </div>
                  </div>
                </div>
     
      `
     } else if(messageType == "video"){

         return `

        <li class="agent clearfix">
          <span class="chat-img left clearfix mx-2">
              <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
          </span>
          <div class="chat-body clearfix agent" style="float:none;background:#77839647;color:#000;">
        <div class="overlay">
            <div class="overlay-1">
              <div class="content-2"  id='popup${taskId}'>
                    <a role="button" data-toggle="modal" data-target="#exampleModalCenter${taskId}"> <div class="Pop" onClick='replypopup(this.id)' id='${taskId}'>Reply</div></a>  
                <a data-toggle="modal" data-target="#exampleModalCenterFlag${taskId}"><div class="pop2">Flag</div></a>
              </div>
            </div>
        </div>
              <div class="header clearfix">
                  <small class="right text-muted" style="color: #000"><span class="glyphicon glyphicon-time"><div id="finalValn${taskId}"><a onClick='replypopup(this.id)' id='${taskId}' role="button" data-toggle="modal" data-target="#exampleModalCenter${taskId}"> Replies : <span id="sizedatan${taskId}"></span></a> </div></span>${stripped1}</small>
                  <strong class="primary-font" class='fullName' style="color: #000">${userName}</strong>
              </div>
           
             <p class='message' style="color: #000 !important">
             <video controls style="width:200px;">
              <source src="${message}"type="video/mp4">
             </video>
             <img class="chevron" onclick="togglePopup(this.id)" id="${taskId}" src="https://img.icons8.com/external-royyan-wijaya-detailed-outline-royyan-wijaya/24/000000/external-chevron-arrow-line-royyan-wijaya-detailed-outline-royyan-wijaya.png"/> 
             </p>

          </div>
      </li>
     <div class="modal fade" id="exampleModalCenter${taskId}" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle${taskId}" aria-hidden="true" data-backdrop="static" data-keyboard="false">
                  <div class="modal-dialog modal-lg" role="document" style="top:40px;">
                  
                  <form id="${taskId}">
                  
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLongTitle${taskId}">Reply</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close" onClick='closepopup(this.id)' id='${taskId}' style="cursor:pointer">
                          &times
                        </button>
                      </div>
                      <div class="msg-body">
                        <h5>${userName} : <label class="msg-detail"> ${message}</label></h5> 
                      </div>
                       <div class="modal-body" style="height:250px;overflow-y:scroll;">
                         <ul class="chat" id="tasksreply${taskId}">
                         </ul>
                      </div>
                      <div class="modal-footer">
                      <input type="file" class="fa fa-paperclip attachment btn btn-primary_1" id='${taskId}' name='inputfile' onChange='getoutput(event,this.id)'/>
                        <input id="btn-input-replyId${taskId}" type="hidden" class="form-control input-lg" value="${taskId}" placeholder="Type your message here..." />
                        <input id="btn-input-replymsg${taskId}" type="text" class="form-control input-lg" value="" placeholder="Type your message here..."  autocomplete="off"/>

       
                        <span class="input-group-btn">
                            <button class="btn btn-primary" type="button" onClick='popupCreate(this.id)' id="${taskId}">
                                <i class="fa fa-paper-plane" aria-hidden="true"></i>
                            </button>
                        </span>
                      </div>
                    </div>
                  </form>
                  </div>
                </div>

              <div class="modal fade" id="exampleModalCenterFlag${taskId}" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                      <div>
                        <h5 class="header-flag" id="exampleModalLongTitle">Reason For Flag</h5>
                      </div>

                       <div class="Flag">
                          <div class="reasonFlag">
                          <a><div class="flag" onClick='flagData(this.id ,"Offensive")' id='${taskId}' value="Offensive">Offensive</div></a>
                          <a><div class="flag" onClick='flagData(this.id ,"Irrevalent")' id='${taskId}' value="Irrevalent">Irrelaavent</div></a>
                          <a><div class="flag" onClick='flagData(this.id ,"Other")' id='${taskId}' value="Other">Other</div></a>
                          <a><div class="flag1" type="button" data-dismiss="modal">Cancel</div></a>
                          </div>
                      </div>
                    
                    </div>
                  </div>
                </div>
      `
     }else if(messageType == "photo"){

         return `

        <li class="agent clearfix">
          <span class="chat-img left clearfix mx-2">
              <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
          </span>
          <div class="chat-body clearfix agent" style="float:none;background:#77839647;color:#000;">
            <div class="overlay">
                <div class="overlay-1">
                  <div class="content-2"  id='popup${taskId}'>
                    <a role="button" data-toggle="modal" data-target="#exampleModalCenter${taskId}"> <div class="Pop" onClick='replypopup(this.id)' id='${taskId}'>Reply</div></a>  
                    <a data-toggle="modal" data-target="#exampleModalCenterFlag${taskId}"><div class="pop2">Flag</div></a>
                  </div>
                </div>
            </div>
              <div class="header clearfix">
                  <small class="right text-muted" style="color: #000"><span class="glyphicon glyphicon-time"><div id="finalValn${taskId}"><a onClick='replypopup(this.id)' id='${taskId}' role="button" data-toggle="modal" data-target="#exampleModalCenter${taskId}"> Replies : <span id="sizedatan${taskId}"></span> </a> </div></span>${stripped1}</small>
                  <strong class="primary-font" class='fullName' style="color: #000">${userName}</strong>
              </div>
              <p class='message' style="color: #000 !important">
             <img src="${message}"   style="width:200px;"/> <img class="chevron" onclick="togglePopup(this.id)" id="${taskId}" src=" https://img.icons8.com/external-royyan-wijaya-detailed-outline-royyan-wijaya/24/000000/external-chevron-arrow-line-royyan-wijaya-detailed-outline-royyan-wijaya.png" />
            
             
              </p>

          </div>
      </li>
      <div class="modal fade" id="exampleModalCenter${taskId}" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle${taskId}" aria-hidden="true" data-backdrop="static" data-keyboard="false">
                  <div class="modal-dialog modal-lg" role="document" style="top:40px;">
                  
                  <form id="${taskId}">
                  
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLongTitle${taskId}">Reply</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close" onClick='closepopup(this.id)' id='${taskId}' style="cursor:pointer">
                          &times
                        </button>
                      </div>
                      <div class="msg-body">
                        <h5>${userName} : <label class="msg-detail"> ${message}</label></h5> 
                      </div>
                       <div class="modal-body" style="height:250px;overflow-y:scroll;">
                         <ul class="chat" id="tasksreply${taskId}">
                         </ul>
                      </div>
                      <div class="modal-footer">
                      <input type="file" class="fa fa-paperclip attachment btn btn-primary_1" id='${taskId}' name='inputfile' onChange='getoutput(event,this.id)'/>
                        <input id="btn-input-replyId${taskId}" type="hidden" class="form-control input-lg" value="${taskId}" placeholder="Type your message here..." />
                        <input id="btn-input-replymsg${taskId}" type="text" class="form-control input-lg" value="" placeholder="Type your message here..."  autocomplete="off"/>

                     
                        <span class="input-group-btn">
                            <button class="btn btn-primary" type="button" onClick='popupCreate(this.id)' id="${taskId}">
                                <i class="fa fa-paper-plane" aria-hidden="true"></i>
                            </button>
                        </span>
                      </div>
                    </div>
                  </form>
                  </div>
                </div>

                <div class="modal fade" id="exampleModalCenterFlag${taskId}" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                      <div>
                        <h5 class="header-flag" id="exampleModalLongTitle">Reason For Flag</h5>
                      </div>

                       <div class="Flag">
                          <div class="reasonFlag">
                          <a><div class="flag" onClick='flagData(this.id ,"Offensive")' id='${taskId}' value="Offensive">Offensive</div></a>
                          <a><div class="flag" onClick='flagData(this.id ,"Irrevalent")' id='${taskId}' value="Irrevalent">Irrelaavent</div></a>
                          <a><div class="flag" onClick='flagData(this.id ,"Other")' id='${taskId}' value="Other">Other</div></a>
                          <a><div class="flag1" type="button" data-dismiss="modal">Cancel</div></a>
                          </div>
                      </div>
                    
                    </div>
                  </div>
                </div>
      `
     }else if(messageType == "document"){

         return `

        <li class="agent clearfix">
          <span class="chat-img left clearfix mx-2">
              <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
          </span>
          <div class="chat-body clearfix agent" style="float:none;background:#77839647;color:#000;">
            <div class="overlay">
                <div class="overlay-1">
                  <div class="content-2"  id='popup${taskId}'>
                    <a role="button" data-toggle="modal" data-target="#exampleModalCenter${taskId}"> <div class="Pop" onClick='replypopup(this.id)' id='${taskId}'>Reply</div></a>  
                    <a data-toggle="modal" data-target="#exampleModalCenterFlag${taskId}"><div class="pop2">Flag</div></a>
                  </div>
                </div>
            </div>
              <div class="header clearfix">
                  <small class="right text-muted" style="color: #000"><span class="glyphicon glyphicon-time"><div id="finalValn${taskId}"><a onClick='replypopup(this.id)' id='${taskId}' role="button" data-toggle="modal" data-target="#exampleModalCenter${taskId}"> Replies : <span id="sizedatan${taskId}"></span></a> </div></span>${stripped1}</small>
                  <strong class="primary-font" class='fullName' style="color: #000">${userName}</strong>
              </div>
               <p class='message'><a href="${message}" target="_blank"> <img class="chevron" onclick="togglePopup(this.id)" id="${taskId}" src=" https://img.icons8.com/external-royyan-wijaya-detailed-outline-royyan-wijaya/24/000000/external-chevron-arrow-line-royyan-wijaya-detailed-outline-royyan-wijaya.png" />
                  <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px"
                  width="25" height="25"
                  viewBox="0 0 172 172"
                  style=" fill:#000000;"><g fill="none" fill-rule="nonzero" stroke="none" stroke-width="1" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="10" stroke-dasharray="" stroke-dashoffset="0" font-family="none" font-weight="none" font-size="none" text-anchor="none" style="mix-blend-mode: normal"><path d="M0,172v-172h172v172z" fill="none"></path><g fill="#ecf0f1"><path d="M44.79167,14.33333c-8.89025,0 -16.125,7.23475 -16.125,16.125v111.08333c0,8.89025 7.23475,16.125 16.125,16.125h82.41667c8.89025,0 16.125,-7.23475 16.125,-16.125v-69.875h-41.20833c-8.89025,0 -16.125,-7.23475 -16.125,-16.125v-41.20833zM96.75,17.48275v38.05892c0,2.96342 2.41158,5.375 5.375,5.375h38.05892z"></path></g></g></svg>
                   ${fName}</a>
              </p>
          </div>
      </li>
     <div class="modal fade" id="exampleModalCenter${taskId}" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle${taskId}" aria-hidden="true" data-backdrop="static" data-keyboard="false">
                  <div class="modal-dialog modal-lg" role="document" style="top:40px;">
                  
                  <form id="${taskId}">
                  
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLongTitle${taskId}">Reply</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close" onClick='closepopup(this.id)' id='${taskId}' style="cursor:pointer">
                          &times
                        </button>
                      </div>
                      <div class="msg-body">
                        <h5>${userName} : <label class="msg-detail"> ${message}</label></h5> 
                      </div>
                       <div class="modal-body" style="height:250px;overflow-y:scroll;">
                         <ul class="chat" id="tasksreply${taskId}">
                         </ul>
                      </div>
                      <div class="modal-footer">
                      <input type="file" class="fa fa-paperclip attachment btn btn-primary_1" id='${taskId}' name='inputfile' onChange='getoutput(event,this.id)'/>
                        <input id="btn-input-replyId${taskId}" type="hidden" class="form-control input-lg" value="${taskId}" placeholder="Type your message here..." />
                        <input id="btn-input-replymsg${taskId}" type="text" class="form-control input-lg" value="" placeholder="Type your message here..."  autocomplete="off"/>

                   
                        <span class="input-group-btn">
                            <button class="btn btn-primary" type="button" onClick='popupCreate(this.id)' id="${taskId}">
                                <i class="fa fa-paper-plane" aria-hidden="true"></i>
                            </button>
                        </span>
                      </div>
                    </div>
                  </form>
                  </div>
                </div>

                <div class="modal fade" id="exampleModalCenterFlag${taskId}" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                      <div>
                        <h5 class="header-flag" id="exampleModalLongTitle">Reason For Flag</h5>
                      </div>

                       <div class="Flag">
                          <div class="reasonFlag">
                          <a><div class="flag" onClick='flagData(this.id ,"Offensive")' id='${taskId}' value="Offensive">Offensive</div></a>
                          <a><div class="flag" onClick='flagData(this.id ,"Irrevalent")' id='${taskId}' value="Irrevalent">Irrelaavent</div></a>
                          <a><div class="flag" onClick='flagData(this.id ,"Other")' id='${taskId}' value="Other">Other</div></a>
                          <a><div class="flag1" type="button" data-dismiss="modal">Cancel</div></a>
                          </div>
                      </div>
                    
                    </div>
                  </div>
                </div> 
      `
     }else{

         return `

        <li class="agent clearfix">
          <span class="chat-img left clearfix mx-2">
              <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
          </span>
          <div class="chat-body clearfix agent" style="float:none;background:#77839647;color:#000;">

            <div class="overlay">
                <div class="overlay-1">
                  <div class="content-2"  id='popup${taskId}'>
                    <a role="button" data-toggle="modal" data-target="#exampleModalCenter${taskId}"> <div class="Pop" onClick='replypopup(this.id)' id='${taskId}'>Reply</div></a>  
                    <a data-toggle="modal" data-target="#exampleModalCenterFlag${taskId}"><div class="pop2">Flag</div></a>
                  </div>
                </div>
            </div>

              <div class="header clearfix">
                  <small class="right text-muted" style="color: #000"><span class="glyphicon glyphicon-time"><div id="finalValn${taskId}"><a onClick='replypopup(this.id)' id='${taskId}' role="button" data-toggle="modal" data-target="#exampleModalCenter${taskId}"> Replies : <span id="sizedatan${taskId}"></span></a> </div></span>${stripped1}</small>
                  <strong class="primary-font" class='fullName' style="color: #000">${userName}</strong>
              </div>
             
              <p class='message'><a href="${message}" target="_blank" style="color:black"> <img class="chevron" onclick="togglePopup(this.id)" id="${taskId}" src=" https://img.icons8.com/external-royyan-wijaya-detailed-outline-royyan-wijaya/24/000000/external-chevron-arrow-line-royyan-wijaya-detailed-outline-royyan-wijaya.png" />
              <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px"
              width="25" height="25"
              viewBox="0 0 172 172"
              style=" fill:#000000;"><g fill="none" fill-rule="nonzero" stroke="none" stroke-width="1" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="10" stroke-dasharray="" stroke-dashoffset="0" font-family="none" font-weight="none" font-size="none" text-anchor="none" style="mix-blend-mode: normal"><path d="M0,172v-172h172v172z" fill="none"></path><g fill="#000000"><path d="M44.79167,14.33333c-8.89025,0 -16.125,7.23475 -16.125,16.125v111.08333c0,8.89025 7.23475,16.125 16.125,16.125h82.41667c8.89025,0 16.125,-7.23475 16.125,-16.125v-69.875h-41.20833c-8.89025,0 -16.125,-7.23475 -16.125,-16.125v-41.20833zM96.75,17.48275v38.05892c0,2.96342 2.41158,5.375 5.375,5.375h38.05892z"></path></g></g></svg>${fName}</a></p>

          </div>
      </li>
     <div class="modal fade" id="exampleModalCenter${taskId}" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle${taskId}" aria-hidden="true" data-backdrop="static" data-keyboard="false">
                  <div class="modal-dialog modal-lg" role="document" style="top:40px;">
                  
                  <form id="${taskId}">
                  
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLongTitle${taskId}">Reply</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close" onClick='closepopup(this.id)' id='${taskId}' style="cursor:pointer">
                        &times
                      </button>
                      </div>
                      <div class="msg-body">
                        <h5>${userName} : <label class="msg-detail"> ${message}</label></h5> 
                      </div>
                       <div class="modal-body" style="height:250px;overflow-y:scroll;">
                         <ul class="chat" id="tasksreply${taskId}">
                         </ul>
                      </div>
                      <div class="modal-footer">
                      <input type="file" class="fa fa-paperclip attachment btn btn-primary_1" id='${taskId}' name='inputfile' onChange='getoutput(event,this.id)'/>
                        <input id="btn-input-replyId${taskId}" type="hidden" class="form-control input-lg" value="${taskId}" placeholder="Type your message here..." />
                        <input id="btn-input-replymsg${taskId}" type="text" class="form-control input-lg" value="" placeholder="Type your message here..."  autocomplete="off"/>

                   
                        <span class="input-group-btn">
                            <button class="btn btn-primary" type="button" onClick='popupCreate(this.id)' id="${taskId}">
                                <i class="fa fa-paper-plane" aria-hidden="true"></i>
                            </button>
                        </span>
                      </div>
                    </div>
                  </form>
                  </div>
                </div>

                <div class="modal fade" id="exampleModalCenterFlag${taskId}" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                      <div>
                        <h5 class="header-flag" id="exampleModalLongTitle">Reason For Flag</h5>
                      </div>

                       <div class="Flag">
                          <div class="reasonFlag">
                          <a><div class="flag" onClick='flagData(this.id ,"Offensive")' id='${taskId}' value="Offensive">Offensive</div></a>
                          <a><div class="flag" onClick='flagData(this.id ,"Irrevalent")' id='${taskId}' value="Irrevalent">Irrelaavent</div></a>
                          <a><div class="flag" onClick='flagData(this.id ,"Other")' id='${taskId}' value="Other">Other</div></a>
                          <a><div class="flag1" type="button" data-dismiss="modal">Cancel</div></a>
                          </div>
                      </div>
                    
                    </div>
                  </div>
                </div>
      `
     }

   }

 
};

function reviewTemplateReply({profileImageUrl,userName,userId, message,createdDate,messageType,messageId},loggedInVal,loggedInName,docId,mainId) {

                // alert(mainId);

                const date = new Date(createdDate); //new Date(createdDate).toDateString();
                  //console.log(date);
                var options = {year: "numeric", month: "long", day: "numeric"};
                var newdate = date.toGMTString('en-US', options);  
                  //console.log(newdate);
                // const stripped = newdate.replace(/GMT/g,"EST" );
                 const stripped = newdate.replace(/GMT/g,"" );

                  //console.log(stripped);
                  // alert(date);
                var newdate1 = stripped.toString(stripped);  
                var newdate2 = newdate1.split(/(\s+)/);
                 newdate2.splice(11, 18);
                 newdate2.splice(0, 2);
                 newdate2.splice(3,3);
                  //console.log(newdate2);
                 function moveArrayItemToNewIndex(arr, old_index, new_index) {
                 if (new_index >= arr.length) {
                      var k = new_index - arr.length + 1;
                      while (k--) {
                          arr.push(undefined);
                      }
                  }
                 arr.splice(new_index, 0, arr.splice(old_index, 1)[0]);
                 return arr;
                 };

                moveArrayItemToNewIndex(newdate2, 0, 2);
                var result1 = moveArrayItemToNewIndex(newdate2, 0, 2);
                //console.log(result1);
                result1.splice(1, 0, ' ');
                var newdate3 = result1.toString(result1);
                var result = newdate3.replace(/,/g, "");
                //console.log(result);
                x = result.substring(0, 6) + "," + result.substring(6, result.length);
                //console.log(x);
                function formatAMPM(date) {
                    var hours = date.getHours();
                    var minutes = date.getMinutes();
                    var ampm = hours >= 12 ? 'PM' : 'AM';
                    hours = hours % 12;
                    hours = hours ? hours : 12; // the hour '0' should be '12'
                    minutes = minutes < 10 ? '0'+minutes : minutes;
                    var strTime = hours + ':' + minutes + ' ' + ampm;
                    return strTime;
                  }

                  var date1 = formatAMPM(date);
                  //console.log(date1);
                  //console.log(newdate2);
                  const stripped1 = x.replace(newdate2[4], date1);
                  //console.log(stripped1);
   
   if(loggedInVal == userId){
        if(messageType == "text"){

           return `

            <li class="admin clearfix">
              <span class="chat-img right clearfix mx-2">
                  <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
              </span>
              <div class="chat-body clearfix">
              <div class="Chev_ron">
              <span class="Chevron" onclick="TogglePopup(this.id)" id="${docId}">
                <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                </svg>
              </span>
            </div>
            <div class="Overlay">
              <div class="Overlay-1">
                <div class="Content"  id='Popup${docId}'>
                  <a onclick="handleDeleteReply('${docId}','${mainId}')"  style="color:white;cursor:pointer;"><div class="Pop2">Delete</div></a>
                </div>
              </div>
            </div>
                  <div class="header clearfix">
                      <small class="left text-muted" style = "display:inline-block;"><span class="glyphicon glyphicon-time"></span>${stripped1}</small>
                      <strong class="right primary-font" class='fullName'>${userName}</strong>
                  </div>
                  <p class='message' onClick='copyClipboard(this.id)' id="${createdDate}">
                      <span id='divClipboard${createdDate}'>${message}<span>
                  </p>
              </div>
          </li>
          `

        }else if(messageType == "photo"){

           return `

            <li class="admin clearfix">
              <span class="chat-img right clearfix mx-2">
                  <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
              </span>
              <div class="chat-body clearfix">
              <div class="Chev_ron">
              <span class="Chevron" onclick="TogglePopup(this.id)" id="${docId}">
                <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                </svg>
              </span>
            </div>
            <div class="Overlay">
                <div class="Overlay-1">
                  <div class="Content"  id='Popup${docId}'>
                    <a onclick="handleDeleteReply('${docId}','${mainId}')" style="color:white;cursor:pointer;"><div class="Pop2">Delete</div></a>
                  </div>
                </div>
            </div>
                  <div class="header clearfix">
                      <small class="left text-muted"><span class="glyphicon glyphicon-time"></span>${stripped1}</small>
                      <strong class="right primary-font" class='fullName'>${userName}</strong>
                  </div>
                    <p class='message'><img src="${message}" class="img-responsive" style="width:200px;"/></p>
              </div>
          </li>
          `

        }else if(messageType == "video"){

          return `

            <li class="admin clearfix">
              <span class="chat-img right clearfix mx-2">
                  <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
              </span>
              <div class="chat-body clearfix">
              <div class="Chev_ron">
              <span class="Chevron" onclick="TogglePopup(this.id)" id="${docId}">
                <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                </svg>
              </span>
            </div>
            <div class="Overlay">
                <div class="Overlay-1">
                  <div class="Content"  id='Popup${docId}'>
                    <a onclick="handleDeleteReply('${docId}','${mainId}')" style="color:white;cursor:pointer;"><div class="Pop2">Delete</div></a>
                  </div>
                </div>
            </div>
                  <div class="header clearfix">
                      <small class="left text-muted"><span class="glyphicon glyphicon-time"></span>${stripped1}</small>
                      <strong class="right primary-font" class='fullName'>${userName}</strong>
                  </div>
                 <p class='message'><video controls style="width:100%;"><source src="${message}" type="video/mp4"></video></p>
              </div>
          </li>
          `
        } else if(messageType == "document"){

          return `

            <li class="admin clearfix">
              <span class="chat-img right clearfix mx-2">
                  <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
              </span>
              <div class="chat-body clearfix">
              <div class="Chev_ron">
              <span class="Chevron" onclick="TogglePopup(this.id)" id="${docId}">
                <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                </svg>
              </span>
            </div>
            <div class="Overlay">
                <div class="Overlay-1">
                  <div class="Content"  id='Popup${docId}'>
                    <a onclick="handleDeleteReply('${docId}','${mainId}')" style="color:white;cursor:pointer;"><div class="Pop2">Delete</div></a>
                  </div>
                </div>
            </div>
                  <div class="header clearfix">
                      <small class="left text-muted"><span class="glyphicon glyphicon-time"></span>${stripped1}</small>
                      <strong class="right primary-font" class='fullName'>${userName}</strong>
                  </div>
                 <p class='message'><a href="${message}" target="_blank">click here to download pdf</a></p>
              </div>
          </li>
          `
        } 
        else {

          return `

            <li class="admin clearfix">
              <span class="chat-img right clearfix mx-2">
                  <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
              </span>
              <div class="chat-body clearfix">
              <div class="Chev_ron">
              <span class="Chevron" onclick="TogglePopup(this.id)" id="${docId}">
                <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                </svg>
              </span>
            </div>
            <div class="Overlay">
                <div class="Overlay-1">
                  <div class="Content"  id='Popup${docId}'>
                    <a onclick="handleDeleteReply('${docId}','${mainId}')" style="color:white;cursor:pointer;"><div class="Pop2">Delete</div></a>
                  </div>
                </div>
            </div>
                  <div class="header clearfix">
                      <small class="left text-muted"><span class="glyphicon glyphicon-time"></span>${stripped1}</small>
                      <strong class="right primary-font" class='fullName'>${userName}</strong>
                  </div>
                <p class='message'><audio controls><source src="${message}" type="audio/mpeg"></audio></p>              </div>
          </li>
          `

        }

   }else{

     if(messageType == "text"){


         return `

        <li class="agent clearfix">
          <span class="chat-img left clearfix mx-2">
              <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
          </span>
          <div class="chat-body clearfix agent" style="float:none;background:#77839647;color:#000;">
              <div class="header clearfix">              
                  <small class="right text-muted" style="color: #000"><span class="glyphicon glyphicon-time"></span>${stripped1}</small>
                  <strong class="primary-font" class='fullName' style="color: #000">${userName}</strong>
              </div>
              <p class='message' style="color: #000 !important">
                      <span id="textMessage${createdDate}">${message}<span>
                  </p>
          </div>
      </li>
      `
     } else if(messageType == "video"){

         return `

        <li class="agent clearfix">
          <span class="chat-img left clearfix mx-2">
              <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
          </span>
          <div class="chat-body clearfix agent" style="float:none;background:#77839647;color:#000;">
          
              <div class="header clearfix">
                  <small class="right text-muted" style="color: #000"><span class="glyphicon glyphicon-time"></span>${stripped1}</small>
                  <strong class="primary-font" class='fullName' style="color: #000">${userName}</strong>
              </div>
           
             <p class='message' style="color: #000 !important"><video controls style="width:100%;"><source src="${message}" type="video/mp4"></video></p>

          </div>
      </li>
      `
     }else if(messageType == "photo"){

         return `

        <li class="agent clearfix">
          <span class="chat-img left clearfix mx-2">
              <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
          </span>
          <div class="chat-body clearfix agent" style="float:none;background:#77839647;color:#000;">
              <div class="header clearfix">
                  <small class="right text-muted" style="color: #000"><span class="glyphicon glyphicon-time"></span>${stripped1}</small>
                  <strong class="primary-font" class='fullName' style="color: #000">${userName}</strong>
              </div>
              <p class='message' style="color: #000 !important"><img src="${message}" class="img-responsive" style="width:200px;"/></p>

          </div>
      </li>
      `
     }else if(messageType == "document"){

          return `

            <li class="admin clearfix">
              <span class="chat-img right clearfix mx-2">
                  <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
              </span>
              <div class="chat-body clearfix">
                  <div class="header clearfix">
                      <small class="left text-muted"><span class="glyphicon glyphicon-time"></span>${stripped1}</small>
                      <strong class="right primary-font" class='fullName'>${userName}</strong>
                  </div>
                 <p class='message'><a href="${message}" target="_blank">click here to download pdf</a></p>
              </div>
          </li>
          `
        } else{

         return `

        <li class="agent clearfix">
          <span class="chat-img left clearfix mx-2">
              <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
          </span>
          <div class="chat-body clearfix agent" style="float:none;background:#77839647;color:#000;">
              <div class="header clearfix">
                  <small class="right text-muted" style="color: #000"><span class="glyphicon glyphicon-time"></span>${stripped1}</small>
                  <strong class="primary-font" class='fullName' style="color: #000">${userName}</strong>
              </div>
             
              <p class='message' style="color: #000 !important"><audio controls><source src="${message}" type="audio/mpeg"></audio></p>            

          </div>
      </li>
      `
     }

   }

 
};



$("#submit").click(function(){
  $(".model-content").css("display", "none")
})


// function reviewTemplateReply({profileImageUrl,userName,userId, message,createdDate,messageType,messageId}) {

//                 var loggedInVal = userId;
//                 var loggedInName = userName;
                
//                 // alert(profileImageUrl);
//                 // alert(userId);
//                 const date = new Date(createdDate); //new Date(createdDate).toDateString();
//                   //console.log(date);
//                 var options = {year: "numeric", month: "long", day: "numeric"};
//                 var newdate = date.toGMTString('en-US', options);  
//                   //console.log(newdate);
//                 const stripped = newdate.replace(/GMT/g, 'EST');
//                   //console.log(stripped);
//                   // alert(date);
//                 var newdate1 = stripped.toString(stripped);  
//                 var newdate2 = newdate1.split(/(\s+)/);
//                  newdate2.splice(11, 18);
//                  newdate2.splice(0, 2);
//                  newdate2.splice(3,3);
//                   //console.log(newdate2);
//                  function moveArrayItemToNewIndex(arr, old_index, new_index) {
//                  if (new_index >= arr.length) {
//                       var k = new_index - arr.length + 1;
//                       while (k--) {
//                           arr.push(undefined);
//                       }
//                   }
//                  arr.splice(new_index, 0, arr.splice(old_index, 1)[0]);
//                  return arr;
//                  };

//                 moveArrayItemToNewIndex(newdate2, 0, 2);
//                 var result1 = moveArrayItemToNewIndex(newdate2, 0, 2);
//                 //console.log(result1);
//                 result1.splice(1, 0, ' ');
//                 var newdate3 = result1.toString(result1);
//                 var result = newdate3.replace(/,/g, "");
//                 //console.log(result);
//                 x = result.substring(0, 6) + "," + result.substring(6, result.length);
//                 //console.log(x);
//                 function formatAMPM(date) {
//                     var hours = date.getHours();
//                     var minutes = date.getMinutes();
//                     var ampm = hours >= 12 ? 'PM' : 'AM';
//                     hours = hours % 12;
//                     hours = hours ? hours : 12; // the hour '0' should be '12'
//                     minutes = minutes < 10 ? '0'+minutes : minutes;
//                     var strTime = hours + ':' + minutes + ' ' + ampm;
//                     return strTime;
//                   }

//                   var date1 = formatAMPM(date);
//                   //console.log(date1);
//                   //console.log(newdate2);
//                   const stripped1 = x.replace(newdate2[4], date1);
//                   //console.log(stripped1);

   
//                    if(loggedInVal == userId){

//                         if(messageType == "text"){

//                            return `

//                             <li class="admin clearfix">
//                               <span class="chat-img right clearfix mx-2">
//                                   <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
//                               </span>
//                               <div class="chat-body clearfix">
//                                   <div class="header clearfix">
//                                       <small class="left text-muted" style = "display:inline-block;"><span class="glyphicon glyphicon-time"></span>${stripped1}</small>
//                                       <strong class="right primary-font" class='fullName'>${userName}</strong>
//                                   </div>
//                                   <p class='message' onClick='copyClipboard(this.id)' id="${taskId}">
//                                       <span id='divClipboard${createdDate}'>${message}<span>
//                                   </p>
//                               </div>
//                           </li>
//                           `

//                         }

//                    }else{

//                      if(messageType == "text"){


//                          return `

//                          <li class="agent clearfix">
//                               <span class="chat-img right clearfix mx-2">
//                                   <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
//                               </span>
//                               <div class="chat-body clearfix">
//                                   <div class="header clearfix">
//                                       <small class="left text-muted" style = "display:inline-block;"><span class="glyphicon glyphicon-time"></span>${stripped1}</small>
//                                       <strong class="right primary-font" class='fullName'>${userName}</strong>
//                                   </div>
//                                   <p class='message' onClick='copyClipboard(this.id)' id="${taskId}">
//                                       <span id='divClipboard${createdDate}'>${message}<span>
//                                   </p>
//                               </div>
//                           </li>
//                       `
//                      } 

//                    }

 
// };

// $(document).ready(function(){
//   $(".message").dblclick(function(){
//     alert("The paragraph was double-clicked.");
//   });
// });

// $('#btn-input-replymsg').emojiPicker({
//   height: '300px',
//   width:  '450px'
// });


function togglePopup(e) {
  $("#popup"+e).toggle()
}

function TogglePopup(e) {
  $("#Popup"+e).toggle()
}


// to close popup outside
$(document).mouseup(function (e) {
  if ($(e.target).closest(".content").length
              === 0) {
      $(".content").hide();
    }
});

$(document).mouseup(function (e) {
  if ($(e.target).closest(".content-2").length
              === 0) {
      $(".content-2").hide();
    }
});


$(document).mouseup(function (e) {
  if ($(e.target).closest(".Content").length
              === 0) {
      $(".Content").hide();
    }
});

$(document).mouseup(function (e) {
  if ($(e.target).closest(".Content-2").length
              === 0) {
      $(".Content-2").hide();
    }
});




function imgError(image) {
    image.onerror = "";
    image.src = "images/userIcon.png";
    return true;
}

function emojifunction(e) 
 {
   alert(e);
   alert("hii");
     new EmojiPicker({
        trigger: [
            {
                selector: '#emoji-buttons'+e,
                insertInto: ['#btn-input-replymsg'+e] // '.selector' can be used without array
            }
        ],
        closeButton: false,
        //specialButtons: green
    });
 }


function copyClipboard(e){
  var copyText = document.getElementById("textMessage"+e).innerText;
  // alert(copyText);
   var elem = document.createElement("textarea");
    document.body.appendChild(elem);
    elem.value = copyText;
    elem.select();
    document.execCommand("copy");
    document.body.removeChild(elem);
    alert("Message has been copied to clipboard..");                             

}

function flagData(e,f){
  // alert(e);
  // alert(f);
  var userIds     = document.getElementById('user_id');
  // console.log(userIds.value);
  var userNamess = document.getElementById("user_nickname");
 // console.log(userNamess.value);
  var id=e;
     var loggedInValss = userIds.value;
     console.log("id  " + loggedInValss);
     var loggedInNamess = userNamess.value;
     console.log("usernames   " + loggedInNamess);


 


    docRef.doc(id).get().then(function(doc) {
  
       console.log(doc.id, " => ", doc.data());

        var id = doc.id;

        var fulldata = doc.data();

        const cityRef = docRef.doc(id);

        console.log(doc.data().flag);

         var txt;
          if (confirm("This comment has been sent for review to the chat room moderator. Thank you.")) {
              if(doc.data().flag == undefined){

                  const res = cityRef.update({flag: [{messageFlag : true, messageFlagMsg : f, messageFlagedUserId : loggedInValss, messageFlagedUserName : loggedInNamess}]});
                  console.log("if value " + res);
                  $("li#"+id).css("display","none");

                }else{

                  const fruits = doc.data().flag;
                  fruits.push({messageFlag : true, messageFlagMsg : f, messageFlagedUserId : loggedInValss, messageFlagedUserName : loggedInNamess});
                    console.log("else value " + JSON.stringify(fruits));
                  const res = cityRef.update({flag: fruits});

                   console.log("else value update " + res);
                   $("li#"+id).css("display","none");

                }
          } else {
            txt = "You pressed Cancel!";
          }

      



      // if(doc.data().flag.messageFlagedUserId == loggedInValss && doc.data().flag.messageFlagedUserName == loggedInNamess){

      //   const res = cityRef.add({flag: [{messageFlag : true, messageFlagMsg : "Offensive", messageFlagedUserId : loggedInValss, messageFlagedUserName : loggedInNamess}]});
      //   console.log("if value " + res);

      // }else{

      //  res = cityRef.add({flag: [{messageFlag : true, messageFlagMsg : "Offensive", messageFlagedUserId : loggedInValss, messageFlagedUserName : loggedInNamess}]});
      //   console.log("else value " + res);

      // }

    });
                     
 }

////////////////////////////////////////////////////////

// $(document).ready(function () {
//   $(".agent clearfix").click(function () {
//       // $("div#overlay").fadeIn('500');
//       // $("div#popup").delay('800');
//       // $("div#popup").fadeIn('500');
//       $('.app_content').css('overflow', 'hidden');  //ADD THIS
//   });
// });
// function replyData(e){
//     docRef.where("messageId", "==", e)
//     .get()
//     .then(function(querySnapshot) {

//         querySnapshot.forEach(function(doc) {
//                 fetchTasksReply(doc.id , doc.data().userId , doc.data().userName , e);
//                 $('#uniqueReplyId').val(doc.id);
//                 // $("#user_nickname").val(doc.data().userName);
//                 // $('#user_id').val(doc.data().userId);

//         });
//     })
//     .catch(function(error) {
//         console.log("Error getting documents: ", error);
//     });                     
// }


function closepopup(id){
  // alert(id);
   $('ul#tasksreply'+id).empty()
  // alert('exampleModalCenter'+id);
  // alert('exampleModalCenteraJWnlbLqkTu8K5P7Dtf8');
  // var finaldataval = '#exampleModalCenter'+id;
//   $('#exampleModalCenter'+id).on('hidden.bs.modal', function() {
    // $(this).find('form#'+id).trigger('reset');
    // alert('hidden event fired!');

//      $(this).removeData();

// });
}

// $("#btn-input-reply").emojioneArea({
//     hideSource: false,
//   });


// $(function () {
    
//       $('#btn-input-reply').emoji();
    
//     })

