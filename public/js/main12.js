var config = {
    apiKey: "AIzaSyA0o46jRmw6OghL2fcpdIcNWDeG1EQ5upQ",
    authDomain: "tradetips-9baa3.firebaseapp.com",
    databaseURL: "https://tradetips-9baa3.firebaseio.com",
    projectId: "tradetips-9baa3",
    type: "service_account",
    project_id: "tradetips-9baa3",
    storageBucket: "tradetips-9baa3.appspot.com",
    messagingSenderId: "592114858590",
    appId: "1:592114858590:web:2e2f77237953b570fb52cf",
    measurementId: "G-B3RPK4JXG3",
    private_key_id: "9efaa0e3e7bf1fac231c69b552514e210442b223",
    private_key: "-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDoxICupYmqJ8yY\nmWkKk8lWp3dKzdAfOkAuyb8yrD9WWYOSUsAMIBY+irMBy74uFeJry8hfHicsBWSW\nuzL04S2S6dlJfeuBFI7GmgNIUG3GDfBROKeUS/XUzY2qg0+dNvgYgFbzoBNc0sMH\nxf4Ezarp/3CDqroWQRD0hvn2zUjNOnWqMP4NcZZfhyNJJcrFyvEWcMs8gWR0r+fQ\nijbGVgqf1n9T+HpGBXkXi9X3tZHe3HW4P6n0gjLU1eU8kOr6V6LDDAngp6ESsuQJ\nAyN81Sz9Axi4hygyWl7Oq7zpitVQxjHwzdMuWMGb/GbnHsleJRYHErk85qaHAvp1\nuS416baJAgMBAAECggEACe+VZJ8ZVMOVJrBpvPNZBVNpsq49Y4/bfIPNHw8eNwPk\nK2NP4lSeTnYiNQHq8NGrVBmjSHgjiOwEArEj+DMCfIJx7YKsAlsLyyt412XjgbBH\noVfvQ1PIvxg1I2GujNHzXixgSc779Jrki1jmwnK7CHkIZv5rKhcF78IxOllB8cyn\nsDdEOkYPAvYeVpIG1j3JQD4Yeo5xyT/MEhzZKqvNeg+uKkDS9R3P5jz94gRTbAtv\n3sKuS6Hrx2tn+BmqhpG1YFlKGMeTpAN42Jf96HJZQQvzho1AmTJh1Ep3fCgMOYhW\n0IJa1JnfVlHlZrL2NmLJ7ac+7yCIBPCXGtkihaHmzwKBgQD4g3si7vB2PBFTXxX5\nTJ0LubY/zyMp0sja/Rp2JYVVHh2WNHa6/TKyxksCG2OlMHbHV99QTrBuIyVYPWbN\njGPeQQAwd+y31RhHyePG99gwxvY8rRSzrEoPev6/6LHM5MdPqNzyujY0w0kUp5UR\nUyANKnCVeOll4IEmApBNfT3UhwKBgQDvx5buPbqdGA4mPKmEq/TLUy4OXVCnd1e3\nOe95qQIcbChCCAkSVeJ3nSvE5d0eBGJNlhaWeTA3DP/963o4frkRmaQJK9BsXdnb\nVj5iG3QRRKCYpamH1kY1AHc/G7P7a4hBPJ+4yblpGBiC7EayG9uBhgDA2sdLOPWW\nF1pZ20TwbwKBgAjz66a5hu4rgdBIF6mQigPXH+qykqi6EERbY+2nsmL7n8M+hpx7\n7KymGiOsSu2zjkPmNYRWIWMGXx0LsT1sdliWbORSHbQNuD811b/gQ+iV8l8DOUCz\nz0M5gh31yxn/j/KducAA110VP/e/hc5G+VugEMhBv97MtLpi00IHZgfXAoGBAIBq\nmWfQwY/+4R0TYgp++aSnUMQ6r8ZwwRaNPbcfj9TfDBSJLyqVuqsrDtTt8qVv3aIF\n3uUJ1Iu3N6arJZL6M228pkCPKZnQDaxNnS133IqfAY+fMZNha8pZDIRM9vCRH7Eo\nobYau2UQlZgQqLAdAUt2FBM1WITt5YFT0nzLVTmbAoGBAO/p5zqkeQ3Yjt7qIs8g\nbQTByK/9TsDRdiK9RfsEKuq70BHLuyYoW6jt9yR4AlbQHEFjGek9mWw4k45aZB5P\n2vjISHPiQoAAGVE9eowmvcckYn+IFFkNIs9s3UBX1d2RBzOgy3XMYE897DWGmKc+\n7F3mTXJtUyyjUqERXKBTYxN0\n-----END PRIVATE KEY-----\n",
    client_email: "firebase-adminsdk-olv1b@tradetips-9baa3.iam.gserviceaccount.com",
    client_id: "112955508654296836542",
    auth_uri: "https://accounts.google.com/o/oauth2/auth",
    token_uri: "https://oauth2.googleapis.com/token",
    auth_provider_x509_cert_url: "https://www.googleapis.com/oauth2/v1/certs",
    client_x509_cert_url: "https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-zgd2j%40chatdemo-96e4f.iam.gserviceaccount.com",
    vapidKey: 'BN2e4vqb2-OY-QX6Z0531oQ1pSiiEUNQU2SEcSaEiMvJFcy8unSAW6gPrFJQeHz0VQyPu2JLqVuaFDnfeDmpy3o'
    // apiKey: "AIzaSyA89MvmT1QzbvnCGfZ8B7yaJRuE3DwaOPE",
    // authDomain: "chatdemo-96e4f.firebaseapp.com",
    // databaseURL: "https://chatdemo-96e4f.firebaseio.com",
    // projectId: "chatdemo-96e4f",
    // type: "service_account",
    // project_id: "chatdemo-96e4f",
    // storageBucket: "chatdemo-96e4f.appspot.com",
    // messagingSenderId: "993956240122",
    // appId: "1:993956240122:web:cb9941a3090a8d029cc743",
    // private_key_id: "9efaa0e3e7bf1fac231c69b552514e210442b223",
    // private_key: "-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDoxICupYmqJ8yY\nmWkKk8lWp3dKzdAfOkAuyb8yrD9WWYOSUsAMIBY+irMBy74uFeJry8hfHicsBWSW\nuzL04S2S6dlJfeuBFI7GmgNIUG3GDfBROKeUS/XUzY2qg0+dNvgYgFbzoBNc0sMH\nxf4Ezarp/3CDqroWQRD0hvn2zUjNOnWqMP4NcZZfhyNJJcrFyvEWcMs8gWR0r+fQ\nijbGVgqf1n9T+HpGBXkXi9X3tZHe3HW4P6n0gjLU1eU8kOr6V6LDDAngp6ESsuQJ\nAyN81Sz9Axi4hygyWl7Oq7zpitVQxjHwzdMuWMGb/GbnHsleJRYHErk85qaHAvp1\nuS416baJAgMBAAECggEACe+VZJ8ZVMOVJrBpvPNZBVNpsq49Y4/bfIPNHw8eNwPk\nK2NP4lSeTnYiNQHq8NGrVBmjSHgjiOwEArEj+DMCfIJx7YKsAlsLyyt412XjgbBH\noVfvQ1PIvxg1I2GujNHzXixgSc779Jrki1jmwnK7CHkIZv5rKhcF78IxOllB8cyn\nsDdEOkYPAvYeVpIG1j3JQD4Yeo5xyT/MEhzZKqvNeg+uKkDS9R3P5jz94gRTbAtv\n3sKuS6Hrx2tn+BmqhpG1YFlKGMeTpAN42Jf96HJZQQvzho1AmTJh1Ep3fCgMOYhW\n0IJa1JnfVlHlZrL2NmLJ7ac+7yCIBPCXGtkihaHmzwKBgQD4g3si7vB2PBFTXxX5\nTJ0LubY/zyMp0sja/Rp2JYVVHh2WNHa6/TKyxksCG2OlMHbHV99QTrBuIyVYPWbN\njGPeQQAwd+y31RhHyePG99gwxvY8rRSzrEoPev6/6LHM5MdPqNzyujY0w0kUp5UR\nUyANKnCVeOll4IEmApBNfT3UhwKBgQDvx5buPbqdGA4mPKmEq/TLUy4OXVCnd1e3\nOe95qQIcbChCCAkSVeJ3nSvE5d0eBGJNlhaWeTA3DP/963o4frkRmaQJK9BsXdnb\nVj5iG3QRRKCYpamH1kY1AHc/G7P7a4hBPJ+4yblpGBiC7EayG9uBhgDA2sdLOPWW\nF1pZ20TwbwKBgAjz66a5hu4rgdBIF6mQigPXH+qykqi6EERbY+2nsmL7n8M+hpx7\n7KymGiOsSu2zjkPmNYRWIWMGXx0LsT1sdliWbORSHbQNuD811b/gQ+iV8l8DOUCz\nz0M5gh31yxn/j/KducAA110VP/e/hc5G+VugEMhBv97MtLpi00IHZgfXAoGBAIBq\nmWfQwY/+4R0TYgp++aSnUMQ6r8ZwwRaNPbcfj9TfDBSJLyqVuqsrDtTt8qVv3aIF\n3uUJ1Iu3N6arJZL6M228pkCPKZnQDaxNnS133IqfAY+fMZNha8pZDIRM9vCRH7Eo\nobYau2UQlZgQqLAdAUt2FBM1WITt5YFT0nzLVTmbAoGBAO/p5zqkeQ3Yjt7qIs8g\nbQTByK/9TsDRdiK9RfsEKuq70BHLuyYoW6jt9yR4AlbQHEFjGek9mWw4k45aZB5P\n2vjISHPiQoAAGVE9eowmvcckYn+IFFkNIs9s3UBX1d2RBzOgy3XMYE897DWGmKc+\n7F3mTXJtUyyjUqERXKBTYxN0\n-----END PRIVATE KEY-----\n",
    // client_email: "firebase-adminsdk-zgd2j@chatdemo-96e4f.iam.gserviceaccount.com",
    // client_id: "112955508654296836542",
    // auth_uri: "https://accounts.google.com/o/oauth2/auth",
    // token_uri: "https://oauth2.googleapis.com/token",
    // auth_provider_x509_cert_url: "https://www.googleapis.com/oauth2/v1/certs",
    // client_x509_cert_url: "https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-zgd2j%40chatdemo-96e4f.iam.gserviceaccount.com"

};

firebase.initializeApp(config);
 
var db = firebase.firestore();


const docRef = db.collection("/openGroups/demoOpenGroup1/messages/");
const tasksDOM = document.getElementById("tasks");

var fullName   = document.getElementById('user_nickname');
var message    = document.getElementById('btn-input');
var userId     = document.getElementById('user_id');
// alert(userId.value);

var hiddenId   = document.getElementById('hiddenId');


var date = document.getElementById('dateval');
// utility functions
function cleanData(snapshots) {
  let data = [];
  snapshots.forEach(function (doc) {
    data.push({ id: doc.id, ...doc.data() });
  });
  return data;
}

// form functions
function handleCreate(event) {

   event.preventDefault();
   var loggedInVal = document.getElementById('user_id').value;
   var loggedInName = document.getElementById('user_nickname').value;
  // var today = Date.now();
   //var str = today.toDateString().split(' ').slice(1).join(' ') + " at " + today.toLocaleTimeString() + " GMT+5:30";
       
  if(message.value != ""){

    let task = {
    userName: loggedInName,
    userId : loggedInVal,
    message: message.value,
    messageId : loggedInVal + "_"+  Date.now(),
    messageType : "text",
    createdDate :  Date.now(),
    profileImageUrl : "https://apistest.tradetipsapp.com/api/appUser/getImageByAppUserId?appUserId="+loggedInVal,
    messageSource : "Web"
    // status: "incomplete"
    };

    return docRef
      .add(task)
      .then((ref) => {
        console.log(ref.id);
        task.id = ref.id;
        // fullName.value = '';
        message.value  = '';
        // date.value = '';
        // return createTask(task);
      });

   } else {
    $(".successmsg").html('<span>Message not empty.</span>');
   }    
 
}



// function handleCreateReply(event) {

//   // alert("reply select");

// var fullName   = document.getElementById('user_nickname');
// // alert(fullName.value);
// var message    = document.getElementById('btn-input-msg');
// var userId     = document.getElementById('user_id');
// // alert(userId.value);
// var docId     = document.getElementById('uniqueReplyId');

//    event.preventDefault();
 
//    var loggedInVal = userId.value;
//    // alert(loggedInVal);
//    var loggedInName = fullName.value;
//    // alert(loggedInName);
//    var uniqueDocId = docId.value;
//    // alert(uniqueDocId);

//    const docRefreply = db.collection("/openGroups/demoOpenGroup1/messages/"+uniqueDocId+"/replies/");

       
//    if(message.value != ""){

//     let taskreply = {
//     userName: loggedInName,
//     userId : loggedInVal,
//     message: message.value,
//     messageId : loggedInVal + "_"+  Date.now(),
//     messageType : "text",
//     createdDate :  Date.now(),
//     profileImageUrl : "https://apistest.tradetipsapp.com/api/appUser/getImageByAppUserId?appUserId="+loggedInVal,
//     messageSource : "Web"
//     // status: "incomplete"
//   };

//   // alert(JSON.stringify(task));
//   return docRefreply
//     .add(taskreply)
//     .then((refs) => {
//       taskreply.id = refs.id;
//       // fullName.value = '';
//       message.value  = '';
//       // date.value = '';
//       // return createTask(task);
//     });

//    }else{
//    // alert("Message not empty");
//     $(".successmsg").html('<span>Message not empty.</span>');
//    }    
 
// }
// function handleStatusUpdate(task) {
//   //
// }

$('i.fa.fa-paperclip.attachment.btn.btn-primary').click(function () {
   // alert("calll");
  $("input[type='file']").trigger('click');
   // alert("data");
});

 
   

$("input[type='file']").on('change', function(e) {
  var val = $(this).val();
  // alert(val);
  // $(this).siblings('span').text(val);
  // $('#btn-input').text(val);

  $(this).siblings('input#btn-input').text(val);

  const file = e.target.files[0];
  // console.log(file);
  // console.log(file.type);

  var loggedInVal = user_id.value;
   var loggedInName = user_nickname.value;
  // alert(loggedInName);
 
  if(file.type == "video/mp4/MOV/WMV/FLV/AVI/AVCHD/WebM/MKV"){

    firebase.storage().ref('message_storage_test_env/').child("photo_message_"+loggedInVal+"_"+"_"+Date.now()).put(file).then(function(snapshot) {
      return snapshot.ref.getDownloadURL()
   }).then(url => {
     console.log("Firebase storage image uploaded : ", url);
       
       
  let task = {
    userName: loggedInName,
    userId : loggedInVal,
    message: url,
    messageId : loggedInVal + "_"+ Date.now(),
    messageType : "video",
    createdDate : Date.now(),
    profileImageUrl : "https://apistest.tradetipsapp.com/api/appUser/getImageByAppUserId?appUserId="+loggedInVal,
    // status: "incomplete"
    messageSource : "Web"
  };
  return docRef
    .add(task)
    .then((ref) => {
      console.log(ref.id);
      task.id = ref.id;
      // fullName.value = '';
      message.value  = '';
      // date.value = '';
      // return createTask(task);
    });


    });

  }else if(file.type == "audio/mpeg/MP3/WAV/WMA/AAC/M4A/FLAC"){

    firebase.storage().ref('message_storage_test_env/').child("photo_message_"+loggedInVal+"_"+"_"+Date.now()).put(file).then(function(snapshot) {
      return snapshot.ref.getDownloadURL()
   }).then(url => {
     console.log("Firebase storage image uploaded : ", url);
       
       
  let task = {
    userName: loggedInName,
    userId : loggedInVal,
    message: url,
    messageId : loggedInVal + "_"+ Date.now(),
    messageType : "audio",
    createdDate : Date.now(),
    profileImageUrl : "https://apistest.tradetipsapp.com/api/appUser/getImageByAppUserId?appUserId="+loggedInVal,
    // status: "incomplete"
    messageSource : "Web"
  };
  return docRef
    .add(task)
    .then((ref) => {
      console.log(ref.id);
      task.id = ref.id;
      // fullName.value = '';
      message.value  = '';
      // date.value = '';
      // return createTask(task);
    });


    });

  
  }else if(file.type == "document/DOC/DOCX/HTML/ODT/PDF/PPT/TXT"){

    firebase.storage().ref('message_storage_test_env/').child("photo_message_"+loggedInVal+"_"+"_"+Date.now()).put(file).then(function(snapshot) {
      return snapshot.ref.getDownloadURL()
   }).then(url => {
     console.log("Firebase storage image uploaded : ", url);
       
       
  let task = {
    userName: loggedInName,
    userId : loggedInVal,
    message: url,
    messageId : loggedInVal + "_"+ Date.now(),
    messageType : "document",
    createdDate : Date.now(),
    profileImageUrl : "https://apistest.tradetipsapp.com/api/appUser/getImageByAppUserId?appUserId="+loggedInVal,
    // status: "incomplete"
    messageSource : "Web"
  };
  return docRef
    .add(task)
    .then((ref) => {
      console.log(ref.id);
      task.id = ref.id;
      // fullName.value = '';
      message.value  = '';
      // date.value = '';
      // return createTask(task);
    });


    });

  } else {


    firebase.storage().ref('message_storage_test_env/').child("photo_message_"+loggedInVal+"_"+"_"+Date.now()).put(file).then(function(snapshot) {
      return snapshot.ref.getDownloadURL()
   }).then(url => {
     console.log("Firebase storage image uploaded : ", url);
       
       
  let task = {
    userName: loggedInName,
    userId : loggedInVal,
    message: url,
    messageId : loggedInVal + "_"+ Date.now(),
    messageType : "photo",
    createdDate : Date.now(),
    profileImageUrl : "https://apistest.tradetipsapp.com/api/appUser/getImageByAppUserId?appUserId="+loggedInVal,
    // status: "incomplete"
    messageSource : "Web"
  };
  return docRef
    .add(task)
    .then((ref) => {
      console.log(ref.id);
      task.id = ref.id;
      // fullName.value = '';
      message.value  = '';
      // date.value = '';
      // return createTask(task);
    });


    });

  }

// return firebase
//     .app()
//     .storage()
//     .ref('message_images')
//     .child(file.name)
//     .put(file)
//     .then(snapshot => {
//       // snapshot represents the uploaded file
//       console.log(snapshot);
//     })
//     .getDownloadURL()
//     .then(imgUrl => {
//       console.log(imgUrl);
//     });

// var remoteimageurl = e.target.files[0]
// var filename = file.name

// fetch(remoteimageurl).then(res => {
//   return res.blob();
// }).then(blob => {
//     //uploading blob to firebase storage
//   firebase.storage().ref('message_storage_test_env/').child(filename).put(blob).then(function(snapshot) {
//     return snapshot.ref.getDownloadURL()
//  }).then(url => {
//    console.log("Firebase storage image uploaded : ", url);
//   })
// }).catch(error => {
//   console.error(error);
// });


 
});

function handleDelete(id) {
    var txt;
          if (confirm("Are you sure you want to delete this chat ?")) {
             return docRef
            .doc(id)
            .delete()
            .then(() => document.getElementById(id).remove());
          } else {
            txt = "You pressed Cancel!";
          }
 
}

// dom functions
function createTask(task) {
  // alert(task);
  // var sData = localStorage.getItem('allTokenData');
  // var storageData= JSON.parse(sData);
  var loggedInVal = user_id.value;
   var loggedInName = "<%= userName %>";

   messaging.onMessage((payload) => {
  alert('Message received. ', payload);
  // ...
});

}


// function totalreplycount(id ,res){

  // const docRefreply = db.collection("/openGroups/demoOpenGroup1/messages/"+id+"/replies/");
  //  docRefreply.orderBy("createdDate", "asc").onSnapshot(function(snapshots) {       
  //     // console.log("size         "  +  snapshots.size);
  //     res.status(200).send({length: snapshots.size});
  //  });


// }

// Firebase functions



function fetchTasks() {
  
//   docRef.where("createdDate", "==", 1642517230000)
// .get()
// .then(function(querySnapshot) {
//     querySnapshot.docChanges().forEach(function(change) {
      // console.log(doc.id);
      // console.log(change.doc.data().flag);
     
   
     docRef.orderBy("createdDate", "desc").limit(100).onSnapshot(function(snapshot) {
        snapshot.docChanges().reverse().forEach(function(change) {

 const docRefreply = db.collection("/openGroups/demoOpenGroup1/messages/"+change.doc.id+"/replies/");
   docRefreply.orderBy("createdDate", "asc").onSnapshot(function(snapshots) {       
      // console.log(snapshots.size);
      $("#sizedata"+change.doc.id).html(snapshots.size);
      $("#sizedatan"+change.doc.id).html(snapshots.size);
   });
        
          // var taskIds = change.doc.id;
          //     $.ajax({

          //       type: 'GET',
          //       url: '/totalreplycount',
          //       data: {ids : taskIds},

          //     success: function(datas) {

          //       console.log("final data  "  + JSON.stringify(datas));

          //     }

          //   });


         // var countReplyss;

       

            if (change.type === "added") {
              
                var task = change.doc.data();

              

                  var userIdcs     = document.getElementById('user_id');
                    // console.log(userIdcs.value);
                    var userNamescs = document.getElementById("user_nickname");
                   // console.log(userNamecss.value);
                    var loggedInVal = userIdcs.value;
                    // console.log(loggedInVal);
                   var loggedInName = userNamescs.value;
                    // console.log(loggedInName);

                      var taskId = change.doc.id;
                      // console.log(taskId);

                    if(task.flag){
                       const result = task.flag.some(obj => obj.messageFlagedUserId === loggedInVal);
                        console.log("checking flag result  " + result);
                        if(result == true){
                          const elem = document.createElement("li");
                          elem.id = change.doc.id;
                          elem.innerHTML = "";
                          tasksDOM.append(elem);

                        }else{
                            // var countReply = countReplyss;
                            const elem = document.createElement("li");
                            elem.id = change.doc.id;
                            elem.innerHTML = reviewTemplate(task,loggedInVal,loggedInName,taskId);
                            tasksDOM.append(elem);
                        }
                      }else{
                            // var countReply = countReplyss;
                            const elem = document.createElement("li");
                            elem.id = change.doc.id;
                            elem.innerHTML = reviewTemplate(task,loggedInVal,loggedInName,taskId);
                            tasksDOM.append(elem);
                      }

              $('.card-body').scrollTop($('.card-body')[0].scrollHeight);


              // const deleteBtn = document.createElement("button");
              // deleteBtn.setAttribute("class", "btn btn-danger col-2 text-white");
              // deleteBtn.innerHTML =
              //   '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>';
              // deleteBtn.addEventListener("click", function () {
              //   return handleDelete(task.messageId);
              // });
              // elem.append(deleteBtn);

              // tasksDOM.append(elem);
            }
            if (change.type === "modified") {
                // console.log("Modified city: ", change.doc.data());
            }
            if (change.type === "removed") {
                // console.log("Removed city: ", change.doc.data());
            }


         });
      });

// });
}

 fetchTasks();

//  function fetchTasksReply(id , userid , userName , messageId) {
//       const docRefreply = db.collection("/openGroups/demoOpenGroup1/messages/"+id+"/replies/");
    
//      docRefreply.orderBy("createdDate", "asc").onSnapshot(function(snapshot) {
//       // alert(snapshot.size);
//         snapshot.docChanges().forEach(function(change) {
//             // alert(JSON.stringify(change.doc.data()));
//             if (change.type === "added") {
//               const tasksDOMReply = document.getElementById("tasksReply");
//                 var taskreply = change.doc.data();
//                     var loggedInVal = userid;
//                     var loggedInName = userName;
//                     const elemreply = document.createElement("li");
//                     elemreply.id = taskreply.messageId;
//                     elemreply.innerHTML = reviewTemplateReply(taskreply);
//                     tasksDOMReply.append(elemreply);

//             }

//         });
//     });


// }





// var reviewForm = document.getElementById('reviewForm');
// // var fullName   = document.getElementById('user_nickname');
// // var message    = document.getElementById('message');
// // var userId     = document.getElementById('user_id');
// // var hiddenId   = document.getElementById('hiddenId');
// // var date = document.getElementById('dateval');

// // reviewForm.addEventListener('submit', (e) => {
// //   e.preventDefault();

// //   if (!fullName.value || !message.value || !date.value) return null

// //   var id = hiddenId.value || Date.now()

// //   db.collection('/openGroups/demoOpenGroup1/messages/').add({
// //     userName: fullName.value,
// //     userId : userId.value,
// //     message: message.value,
// //     createdDate : date.value
// //   }).then(function(doc) {
// //         // console.log(docRef);
// //         // console.log("Document written with ID: ", docRef.id);

// //   var li = document.createElement('li')
// //   li.id = doc.id;
// //   li.innerHTML = reviewTemplate('<li class="admin clearfix"><span class="chat-img right clearfix mx-2"><img src="https://apistest.tradetipsapp.com/api/appUser/getImageByAppUserId?appUserId=d9aced23-7b89-4abc-bd71-5523ab83a98a" alt="Admin" class="img-circle" style="width: 100%;"/></span><div class="chat-body clearfix"><div class="header clearfix"><small class="left text-muted"><span class="glyphicon glyphicon-time"></span>' + createdDate + '</small><strong class="right primary-font" class="fullName"> ' + userName + '</strong></div><p class="message"> ' + message + '</p></div></li>')
// //   reviews.appendChild(li);

// //     });

 

// //     fullName.value = '';
// //     message.value  = '';
// //     hiddenId.value = '';
// //     date.value = '';

// //   });

// // // READ REVEIWS



 

// // var reviews = document.getElementById('reviews');
// // var reviewsRef = db.ref("/reviews");
// // var reviewsRef = db.collection('openGroups').doc('demoOpenGroup1').collection('messages');
// // var reviewsRef = db.collection("/openGroups/demoOpenGroup1/messages").get().then((querySnapshot) => {
     
// //     // querySnapshot.forEach((doc) => {
// //         // alert(`${doc.id} => ${doc.data()}`);
// //          // sub_array.push(doc.data());

// //   // var li = document.createElement('li')
// //   // li.id = doc.id;
// //   // li.innerHTML = reviewTemplate(doc.data())
// //   // reviews.appendChild(li);
       
         
// //     // });

// //   });


// // var reviewsRef =

//  // db.collection("/openGroups/demoOpenGroup1/messages").get().then((querySnapshot) => {

//  //        var sub_array = [];
     
//  //    querySnapshot.forEach((doc) => {
//  //        // alert(`${doc.id} => ${doc.data()}`);
//  //         // sub_array.push(doc.data());
//  //    // alert(doc.id);
//  //  var li = document.createElement('li')
//  //  li.id = doc.id;
//  //  li.innerHTML = reviewTemplate(doc.data())
//  //  reviews.appendChild(li);
       
         
//  //    });

//  //  });

// // reviewsRef.on('child_added', (data) => {
// //   alert("add value" + data.val());
// //   var li = document.createElement('li')
// //   li.id = data.key;
// //   li.innerHTML = reviewTemplate(data.val())
// //   reviews.appendChild(li);
// // });


// // reviewsRef.on('child_changed', (data) => {
// //   alert("change" + data);
// //   var reviewNode = document.getElementById(data.key);
// //   reviewNode.innerHTML = reviewTemplate(data.val());
// // });

// // reviewsRef.on('child_removed', (data) => {
// //   alert("remove" + data);
// //   var reviewNode = document.getElementById(data.key);
// //   reviewNode.parentNode.removeChild(reviewNode);
// // });

// // reviews.addEventListener('click', (e) => {
// //   var reviewNode = e.target.parentNode

// //   // UPDATE REVEIW
// //   if (e.target.classList.contains('edit')) {
// //     fullName.value = reviewNode.querySelector('.fullName').innerText;
// //     message.value  = reviewNode.querySelector('.message').innerText;
// //     hiddenId.value = reviewNode.id;
// //   }

// //   // DELETE REVEIW
// //   if (e.target.classList.contains('delete')) {
// //     var id = reviewNode.id;
// //     db.ref('reviews/' + id).remove();
// //   }
// // });
function reviewTemplate({profileImageUrl,userName,userId, message,createdDate,messageType,messageId},loggedInName,loggedInVal,taskId) {

 // console.log("userid " + userId);
 // console.log("logged In " + loggedInName);

                const date = new Date(createdDate); //new Date(createdDate).toDateString();
                  //console.log(date);
                var options = {year: "numeric", month: "long", day: "numeric"};
                var newdate = date.toGMTString('en-US', options);  
                  //console.log(newdate);
                const stripped = newdate.replace(/GMT/g, 'EST');
                  //console.log(stripped);
                  // alert(date);
                var newdate1 = stripped.toString(stripped);  
                var newdate2 = newdate1.split(/(\s+)/);
                 newdate2.splice(11, 18);
                 newdate2.splice(0, 2);
                 newdate2.splice(3,3);
                  //console.log(newdate2);
                 function moveArrayItemToNewIndex(arr, old_index, new_index) {
                 if (new_index >= arr.length) {
                      var k = new_index - arr.length + 1;
                      while (k--) {
                          arr.push(undefined);
                      }
                  }
                 arr.splice(new_index, 0, arr.splice(old_index, 1)[0]);
                 return arr;
                 };

                moveArrayItemToNewIndex(newdate2, 0, 2);
                var result1 = moveArrayItemToNewIndex(newdate2, 0, 2);
                //console.log(result1);
                result1.splice(1, 0, ' ');
                var newdate3 = result1.toString(result1);
                var result = newdate3.replace(/,/g, "");
                //console.log(result);
                x = result.substring(0, 6) + "," + result.substring(6, result.length);
                //console.log(x);
                function formatAMPM(date) {
                    var hours = date.getHours();
                    var minutes = date.getMinutes();
                    var ampm = hours >= 12 ? 'PM' : 'AM';
                    hours = hours % 12;
                    hours = hours ? hours : 12; // the hour '0' should be '12'
                    minutes = minutes < 10 ? '0'+minutes : minutes;
                    var strTime = hours + ':' + minutes + ' ' + ampm;
                    return strTime;
                  }

                  var date1 = formatAMPM(date);
                  //console.log(date1);
                  //console.log(newdate2);
                  const stripped1 = x.replace(newdate2[4], date1);
                  //console.log(stripped1);
   
   if(loggedInName == userId){

        if(messageType == "text"){

           return `

            <li class="admin clearfix">
           
              <span class="chat-img right clearfix mx-2">
                  <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
              </span>
              <div class="chat-body clearfix">
              <div class="Chev_ron">
              <span class="Chevron" onclick="TogglePopup(this.id)" id="${taskId}">
                <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                </svg>
              </span>
            </div>
            <div class="Overlay">
                <div class="Overlay-1">
                  <div class="Content"  id='Popup${taskId}'>
                    <div  class="Pop"><a href="replyMsg?messageId=${taskId}" target="_blank"><span id="sizedata${taskId}"></span> Reply </a> </div> 
                    <a onClick='copyClipboard(this.id)' id='${taskId}'><div class="Pop">Copy</div></a>
                    <a onClick='handleDelete(this.id)' id='${taskId}' style="color:white;cursor:pointer;"><div class="Pop2">Delete</div></a>
                  </div>
                </div>
            </div>
                  <div class="header clearfix">
                      <small class="left text-muted" style = "display:inline-block;"><span class="glyphicon glyphicon-time"><div><a href="replyMsg?messageId=${taskId}" target="_blank"> <span id="sizedatan${taskId}"></span> Reply </a> </div></span>${stripped1}</small>
                    
                      <strong class="right primary-font" class='fullName'>${userName}</strong>
                  </div>
                  <p class='message' onClick='copyClipboard(this.id)' id="${taskId}">
                      <span id='divClipboard${taskId}'>${message}<span>

                  </p>
                  
              </div>
             
          </li>
          `

        }else if(messageType == "photo"){

           return `

            <li class="admin clearfix">
              <span class="chat-img right clearfix mx-2">
                  <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
              </span>
              <div class="chat-body clearfix">
              <div class="Chev_ron">
              <span class="Chevron" onclick="TogglePopup(this.id)" id="${taskId}">
                <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                </svg>
              </span>
            </div>
              <div class="Overlay">
                  <div class="Overlay-1">
                    <div class="Content-2"  id='Popup${taskId}'>
                      <div  class="Pop" ><a href="replyMsg?messageId=${taskId}" target="_blank"> <span id="sizedata${taskId}"></span> Reply </a> </div> 
                      <a onClick='handleDelete(this.id)' id='${taskId}' style="color:white;cursor:pointer;"><div class="Pop2">Delete</div></a>
                    </div>
                  </div>
              </div>
                  <div class="header clearfix">
                      <small class="left text-muted"><span class="glyphicon glyphicon-time"><div><a href="replyMsg?messageId=${taskId}" target="_blank"> <span id="sizedatan${taskId}"></span> Reply </a> </div></span>${stripped1}</small>
                       
                      <strong class="right primary-font" class='fullName'>${userName}</strong>
                  </div>
                    <p class='message'><img src="${message}" class="img-responsive" style="width:100%;"/></p>
              </div>
          </li>
          `

        }else if(messageType == "video"){

          return `

            <li class="admin clearfix">
              <span class="chat-img right clearfix mx-2">
                  <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
              </span>
              <div class="chat-body clearfix">
              <div class="Chev_ron">
              <span class="Chevron" onclick="TogglePopup(this.id)" id="${taskId}">
                <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                </svg>
              </span>
            </div>
              <div class="Overlay">
                  <div class="Overlay-1">
                    <div class="Content-2"  id='Popup${taskId}'>
                      <div  class="Pop" ><a href="replyMsg?messageId=${taskId}" target="_blank"><span id="sizedata${taskId}"></span> Reply </a> </div> 
                      <a onClick='handleDelete(this.id)' id='${taskId}' style="color:white;cursor:pointer;"><div class="Pop2">Delete</div></a>
                    </div>
                  </div>
              </div>
                  <div class="header clearfix">
                      <small class="left text-muted"><span class="glyphicon glyphicon-time"><div><a href="replyMsg?messageId=${taskId}" target="_blank"> <span id="sizedatan${taskId}"></span> Reply </a> </div></span>${stripped1}</small>
                     
                      <strong class="right primary-font" class='fullName'>${userName}</strong>
                  </div>
                 <p class='message'><video controls style="width:100%;"><source src="${message}" type="video/mp4"></video></p>
              </div>
          </li>
          `
        
        }else if(messageType == "document"){

          return `

            <li class="admin clearfix">
              <span class="chat-img right clearfix mx-2">
                  <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
              </span>
              <div class="chat-body clearfix">
              <div class="Chev_ron">
              <span class="Chevron" onclick="TogglePopup(this.id)" id="${taskId}">
                <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                </svg>
              </span>
            </div>
              <div class="Overlay">
                  <div class="Overlay-1">
                    <div class="Content-2"  id='Popup${taskId}'>
                      <div  class="Pop" ><a href="replyMsg?messageId=${taskId}" target="_blank"><span id="sizedata${taskId}"></span> Reply </a> </div> 
                      <a onClick='handleDelete(this.id)' id='${taskId}' style="color:white;cursor:pointer;"><div class="Pop2">Delete</div></a>
                    </div>
                  </div>
              </div>
                  <div class="header clearfix">
                      <small class="left text-muted"><span class="glyphicon glyphicon-time"><div><a href="replyMsg?messageId=${taskId}" target="_blank"> <span id="sizedatan${taskId}"></span> Reply </a> </div></span>${stripped1}</small>
                     
                      <strong class="right primary-font" class='fullName'>${userName}</strong>
                  </div>
                 <p class='message'><video controls style="width:100%;"><source src="${message}" type="video/mp4"></video></p>
              </div>
          </li>
          `
        } else {

          return `

            <li class="admin clearfix">
              <span class="chat-img right clearfix mx-2">
                  <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
              </span>
              <div class="chat-body clearfix">
              <div class="Chev_ron">
                  <span class="Chevron" onclick="TogglePopup(this.id)" id="${taskId}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                    </svg>
                  </span>
                </div>
                  <div class="Overlay">
                      <div class="Overlay-1">
                        <div class="Content-2"  id='Popup${taskId}'>
                          <div  class="Pop" ><a href="replyMsg?messageId=${taskId}" target="_blank"> <span id="sizedata${taskId}"></span> Reply </a> </div> 
                          <a onClick='handleDelete(this.id)' id='${taskId}' style="color:white;cursor:pointer;"><div class="Pop2">Delete</div></a>
                        </div>
                      </div>
                  </div>
                  <div class="header clearfix">
                      <small class="left text-muted"><span class="glyphicon glyphicon-time"><div><a href="replyMsg?messageId=${taskId}" target="_blank"> <span id="sizedatan${taskId}"></span> Reply </a> </div></span>${stripped1}</small>
                     
                      <strong class="right primary-font" class='fullName'>${userName}</strong>
                  </div>
                <p class='message'><audio controls><source src="${message}" type="audio/mpeg"></audio></p>              </div>
          </li>
          `

        }

   }else{




     if(messageType == "text"){


         return `

        <li class="agent clearfix">
          <span class="chat-img left clearfix mx-2">
              <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
          </span>
          
          <div class="chat-body clearfix agent" style="float:none;background:#77839647;color:#000;" >
          <div class="chev_ron">
            <span class="chevron" onclick="togglePopup(this.id)" id="${taskId}">
              <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
              <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
              </svg>
            </span>
          </div>
          <div class="overlay">
              <div class="overlay-1">
              <div class="content"  id='popup${taskId}'>
              <div  class="pop"><a href="replyMsg?messageId=${taskId}" target="_blank"><span id="sizedata${taskId}"></span> Reply </a> </div> 
              <a onClick='copyClipboard(this.id)' id='${taskId}'><div class="pop" style="cursor:pointer;">Copy</div></a>
              <a onClick='flagData(this.id)' id='${taskId}'><div class="pop2">Flag</div></a>
              </div>
              </div>
          </div>
         
              <div class="header clearfix">
                  <small class="right text-muted" style="color: #000"><span class="glyphicon glyphicon-time"><div><a href="replyMsg?messageId=${taskId}" target="_blank"> <span id="sizedatan${taskId}"></span> Reply </a> </div></span>${stripped1} </small>
                  <strong class="primary-font" class='fullName' style="color: #000">${userName}</strong>
              </div>
              <p class='message' style="color: #000 !important" >
                      <span id="textMessage${taskId}">${message}<span>
               </p>

              
          </div>
          
          
      </li>
      `
     } else if(messageType == "video"){

         return `

        <li class="agent clearfix">
          <span class="chat-img left clearfix mx-2">
              <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
          </span>
          <div class="chat-body clearfix agent" style="float:none;background:#77839647;color:#000;">
            <div class="chev_ron">
              <span class="chevron" onclick="togglePopup(this.id)" id="${taskId}">
                <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                </svg>
              </span>
            </div>
        <div class="overlay">
            <div class="overlay-1">
              <div class="content-2"  id='popup${taskId}'>
                <div  class="pop"><a href="replyMsg?messageId=${taskId}" target="_blank">  <span id="sizedata${taskId}"></span> Reply </a> </div> 
                <a onClick='flagData(this.id)' id='${taskId}'><div class="pop2">Flag</div></a>
              </div>
            </div>
        </div>
              <div class="header clearfix">
                  <small class="right text-muted" style="color: #000"><span class="glyphicon glyphicon-time"><div><a href="replyMsg?messageId=${taskId}" target="_blank"> <span id="sizedatan${taskId}"></span> Reply </a> </div></span>${stripped1}</small>
                  <strong class="primary-font" class='fullName' style="color: #000">${userName}</strong>
              </div>
           
             <p class='message' style="color: #000 !important"><video controls style="width:100%;"><source src="${message}" type="video/mp4"></video></p>

          </div>
      </li>
      `
     }else if(messageType == "photo"){

         return `

        <li class="agent clearfix">
          <span class="chat-img left clearfix mx-2">
              <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
          </span>
          <div class="chat-body clearfix agent" style="float:none;background:#77839647;color:#000;">
          <div class="chev_ron">
            <span class="chevron" onclick="togglePopup(this.id)" id="${taskId}">
              <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
              <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
              </svg>
            </span>
            </div>
            <div class="overlay">
                <div class="overlay-1">
                  <div class="content-2"  id='popup${taskId}'>
                    <div  class="pop"><a href="replyMsg?messageId=${taskId}" target="_blank"> <span id="sizedata${taskId}"></span> Reply </a> </div> 
                    <a onClick='flagData(this.id)' id='${taskId}'><div class="pop2">Flag</div></a>
                  </div>
                </div>
            </div>
              <div class="header clearfix">
                  <small class="right text-muted" style="color: #000"><span class="glyphicon glyphicon-time"><div><a href="replyMsg?messageId=${taskId}" target="_blank"><span id="sizedatan${taskId}"></span> Reply </a> </div></span>${stripped1}</small>
                  <strong class="primary-font" class='fullName' style="color: #000">${userName}</strong>
              </div>
              <p class='message' style="color: #000 !important"><img src="${message}" class="img-responsive" style="width:100%;"/></p>

          </div>
      </li>
      `
     }else if(messageType == "document"){

         return `

        <li class="agent clearfix">
          <span class="chat-img left clearfix mx-2">
              <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
          </span>
          <div class="chat-body clearfix agent" style="float:none;background:#77839647;color:#000;">
          <div class="chev_ron">
            <span class="chevron" onclick="togglePopup(this.id)" id="${taskId}">
              <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
              <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
              </svg>
            </span>
            </div>
            <div class="overlay">
                <div class="overlay-1">
                  <div class="content-2"  id='popup${taskId}'>
                    <div  class="pop"><a href="replyMsg?messageId=${taskId}" target="_blank"> <span id="sizedata${taskId}"></span> Reply </a> </div> 
                    <a onClick='flagData(this.id)' id='${taskId}'><div class="pop2">Flag</div></a>
                  </div>
                </div>
            </div>
              <div class="header clearfix">
                  <small class="right text-muted" style="color: #000"><span class="glyphicon glyphicon-time"><div><a href="replyMsg?messageId=${taskId}" target="_blank"><span id="sizedatan${taskId}"></span> Reply </a> </div></span>${stripped1}</small>
                  <strong class="primary-font" class='fullName' style="color: #000">${userName}</strong>
              </div>
              <p class='message' style="color: #000 !important"><img src="${message}" class="img-responsive" style="width:100%;"/></p>

          </div>
      </li>
      `
     }else{

         return `

        <li class="agent clearfix">
          <span class="chat-img left clearfix mx-2">
              <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
          </span>
          <div class="chat-body clearfix agent" style="float:none;background:#77839647;color:#000;">
          <div class="chev_ron"> 
            <span class="chevron" onclick="togglePopup(this.id)" id="${taskId}">
              <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
              <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
              </svg>
            </span>
          </div>
            <div class="overlay">
                <div class="overlay-1">
                  <div class="content-2"  id='popup${taskId}'>
                    <div  class="pop"><a href="replyMsg?messageId=${taskId}" target="_blank">  <span id="sizedata${taskId}"></span> Reply </a> </div> 
                    <a onClick='flagData(this.id)' id='${taskId}'><div class="pop2">Flag</div></a>
                  </div>
                </div>
            </div>

              <div class="header clearfix">
                  <small class="right text-muted" style="color: #000"><span class="glyphicon glyphicon-time"><div><a href="replyMsg?messageId=${taskId}" target="_blank"> <span id="sizedatan${taskId}"></span> Reply </a> </div></span>${stripped1}</small>
                  <strong class="primary-font" class='fullName' style="color: #000">${userName}</strong>
              </div>
             
              <p class='message' style="color: #000 !important"><audio controls><source src="${message}" type="audio/mpeg"></audio></p>            

          </div>
      </li>
      `
     }

   }

 
};



// function reviewTemplateReply({profileImageUrl,userName,userId, message,createdDate,messageType,messageId}) {

//                 var loggedInVal = userId;
//                 var loggedInName = userName;
                
//                 // alert(profileImageUrl);
//                 // alert(userId);
//                 const date = new Date(createdDate); //new Date(createdDate).toDateString();
//                   //console.log(date);
//                 var options = {year: "numeric", month: "long", day: "numeric"};
//                 var newdate = date.toGMTString('en-US', options);  
//                   //console.log(newdate);
//                 const stripped = newdate.replace(/GMT/g, 'EST');
//                   //console.log(stripped);
//                   // alert(date);
//                 var newdate1 = stripped.toString(stripped);  
//                 var newdate2 = newdate1.split(/(\s+)/);
//                  newdate2.splice(11, 18);
//                  newdate2.splice(0, 2);
//                  newdate2.splice(3,3);
//                   //console.log(newdate2);
//                  function moveArrayItemToNewIndex(arr, old_index, new_index) {
//                  if (new_index >= arr.length) {
//                       var k = new_index - arr.length + 1;
//                       while (k--) {
//                           arr.push(undefined);
//                       }
//                   }
//                  arr.splice(new_index, 0, arr.splice(old_index, 1)[0]);
//                  return arr;
//                  };

//                 moveArrayItemToNewIndex(newdate2, 0, 2);
//                 var result1 = moveArrayItemToNewIndex(newdate2, 0, 2);
//                 //console.log(result1);
//                 result1.splice(1, 0, ' ');
//                 var newdate3 = result1.toString(result1);
//                 var result = newdate3.replace(/,/g, "");
//                 //console.log(result);
//                 x = result.substring(0, 6) + "," + result.substring(6, result.length);
//                 //console.log(x);
//                 function formatAMPM(date) {
//                     var hours = date.getHours();
//                     var minutes = date.getMinutes();
//                     var ampm = hours >= 12 ? 'PM' : 'AM';
//                     hours = hours % 12;
//                     hours = hours ? hours : 12; // the hour '0' should be '12'
//                     minutes = minutes < 10 ? '0'+minutes : minutes;
//                     var strTime = hours + ':' + minutes + ' ' + ampm;
//                     return strTime;
//                   }

//                   var date1 = formatAMPM(date);
//                   //console.log(date1);
//                   //console.log(newdate2);
//                   const stripped1 = x.replace(newdate2[4], date1);
//                   //console.log(stripped1);

   
//                    if(loggedInVal == userId){

//                         if(messageType == "text"){

//                            return `

//                             <li class="admin clearfix">
//                               <span class="chat-img right clearfix mx-2">
//                                   <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
//                               </span>
//                               <div class="chat-body clearfix">
//                                   <div class="header clearfix">
//                                       <small class="left text-muted" style = "display:inline-block;"><span class="glyphicon glyphicon-time"></span>${stripped1}</small>
//                                       <strong class="right primary-font" class='fullName'>${userName}</strong>
//                                   </div>
//                                   <p class='message' onClick='copyClipboard(this.id)' id="${taskId}">
//                                       <span id='divClipboard${createdDate}'>${message}<span>
//                                   </p>
//                               </div>
//                           </li>
//                           `

//                         }

//                    }else{

//                      if(messageType == "text"){


//                          return `

//                          <li class="agent clearfix">
//                               <span class="chat-img right clearfix mx-2">
//                                   <img onerror="imgError(this);" src="${profileImageUrl}" alt="Admin" class="img-circle" style="width: 50px;height: 50px;"/>
//                               </span>
//                               <div class="chat-body clearfix">
//                                   <div class="header clearfix">
//                                       <small class="left text-muted" style = "display:inline-block;"><span class="glyphicon glyphicon-time"></span>${stripped1}</small>
//                                       <strong class="right primary-font" class='fullName'>${userName}</strong>
//                                   </div>
//                                   <p class='message' onClick='copyClipboard(this.id)' id="${taskId}">
//                                       <span id='divClipboard${createdDate}'>${message}<span>
//                                   </p>
//                               </div>
//                           </li>
//                       `
//                      } 

//                    }

 
// };

// $(document).ready(function(){
//   $(".message").dblclick(function(){
//     alert("The paragraph was double-clicked.");
//   });
// });

function togglePopup(e) {
  $("#popup"+e).toggle()
}

function TogglePopup(e) {
  $("#Popup"+e).toggle()
}


// to close popup outside
$(document).mouseup(function (e) {
  if ($(e.target).closest(".content").length
              === 0) {
      $(".content").hide();
    }
});

$(document).mouseup(function (e) {
  if ($(e.target).closest(".content-2").length
              === 0) {
      $(".content-2").hide();
    }
});


$(document).mouseup(function (e) {
  if ($(e.target).closest(".Content").length
              === 0) {
      $(".Content").hide();
    }
});

$(document).mouseup(function (e) {
  if ($(e.target).closest(".Content-2").length
              === 0) {
      $(".Content-2").hide();
    }
});




function imgError(image) {
    image.onerror = "";
    image.src = "images/userIcon.png";
    return true;
}

function copyClipboard(e){
  var copyText = document.getElementById("textMessage"+e).innerText;
  // alert(copyText);
   var elem = document.createElement("textarea");
    document.body.appendChild(elem);
    elem.value = copyText;
    elem.select();
    document.execCommand("copy");
    document.body.removeChild(elem);
    alert("Message Copied !!");                             

}

function flagData(e){
  var userIds     = document.getElementById('user_id');
  // console.log(userIds.value);
  var userNamess = document.getElementById("user_nickname");
 // console.log(userNamess.value);
  var id=e;


     var loggedInValss = userIds.value;
     console.log("id  " + loggedInValss);
     var loggedInNamess = userNamess.value;
     console.log("usernames   " + loggedInNamess);


 


    docRef.doc(id).get().then(function(doc) {
  
       console.log(doc.id, " => ", doc.data());

        var id = doc.id;

        var fulldata = doc.data();

        const cityRef = docRef.doc(id);

        console.log(doc.data().flag);

         var txt;
          if (confirm("Are you sure you want to flag this chat ?")) {
              if(doc.data().flag == undefined){

                  const res = cityRef.update({flag: [{messageFlag : true, messageFlagMsg : "Offensive", messageFlagedUserId : loggedInValss, messageFlagedUserName : loggedInNamess}]});
                  console.log("if value " + res);
                  $("li#"+id).css("display","none");

                }else{

                  const fruits = doc.data().flag;
                  fruits.push({messageFlag : true, messageFlagMsg : "Offensive", messageFlagedUserId : loggedInValss, messageFlagedUserName : loggedInNamess});
                    console.log("else value " + JSON.stringify(fruits));
                  const res = cityRef.update({flag: fruits});

                   console.log("else value update " + res);
                   $("li#"+id).css("display","none");

                }
          } else {
            txt = "You pressed Cancel!";
          }

      



      // if(doc.data().flag.messageFlagedUserId == loggedInValss && doc.data().flag.messageFlagedUserName == loggedInNamess){

      //   const res = cityRef.add({flag: [{messageFlag : true, messageFlagMsg : "Offensive", messageFlagedUserId : loggedInValss, messageFlagedUserName : loggedInNamess}]});
      //   console.log("if value " + res);

      // }else{

      //  res = cityRef.add({flag: [{messageFlag : true, messageFlagMsg : "Offensive", messageFlagedUserId : loggedInValss, messageFlagedUserName : loggedInNamess}]});
      //   console.log("else value " + res);

      // }

    });
                     
}

// $(document).ready(function () {
//   $(".agent clearfix").click(function () {
//       // $("div#overlay").fadeIn('500');
//       // $("div#popup").delay('800');
//       // $("div#popup").fadeIn('500');
//       $('.app_content').css('overflow', 'hidden');  //ADD THIS
//   });
// });
// function replyData(e){
//     docRef.where("messageId", "==", e)
//     .get()
//     .then(function(querySnapshot) {

//         querySnapshot.forEach(function(doc) {
//                 fetchTasksReply(doc.id , doc.data().userId , doc.data().userName , e);
//                 $('#uniqueReplyId').val(doc.id);
//                 // $("#user_nickname").val(doc.data().userName);
//                 // $('#user_id').val(doc.data().userId);

//         });
//     })
//     .catch(function(error) {
//         console.log("Error getting documents: ", error);
//     });                     
// }


  

